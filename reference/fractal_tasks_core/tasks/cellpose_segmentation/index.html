
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../calculate_registration_image_based/">
      
      
        <link rel="next" href="../cellpose_utils/">
      
      <link rel="icon" href="https://raw.githubusercontent.com/fractal-analytics-platform/fractal-logos/refs/heads/main/common/fractal_favicon.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-9.1.21">
    
    
      
        <title>cellpose_segmentation - Fractal Tasks Core</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.eebd395e.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../../extra.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="light-blue">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#fractal_tasks_core.tasks.cellpose_segmentation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="Fractal Tasks Core" class="md-header__button md-logo" aria-label="Fractal Tasks Core" data-md-component="logo">
      
  <img src="https://raw.githubusercontent.com/fractal-analytics-platform/fractal-logos/refs/heads/main/common/fractal_logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Fractal Tasks Core
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              cellpose_segmentation
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="light-blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="light-blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
              </label>
            
          
        </form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/fractal-analytics-platform/fractal-tasks-core" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    fractal-tasks-core
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Fractal Tasks Core" class="md-nav__button md-logo" aria-label="Fractal Tasks Core" data-md-component="logo">
      
  <img src="https://raw.githubusercontent.com/fractal-analytics-platform/fractal-logos/refs/heads/main/common/fractal_logo.png" alt="logo">

    </a>
    Fractal Tasks Core
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/fractal-analytics-platform/fractal-tasks-core" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    fractal-tasks-core
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        Home page
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../install/" class="md-nav__link">
        Install
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../run_tasks/">Run tasks</a>
          
            <label for="__nav_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Run tasks
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../run_tasks/tasks_in_fractal/" class="md-nav__link">
        Within Fractal
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../run_tasks/tasks_in_scripts/" class="md-nav__link">
        From Python scripts
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../all_tasks/" class="md-nav__link">
        Task list
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../tables/" class="md-nav__link">
        Table specs
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../custom_task/" class="md-nav__link">
        Write custom tasks
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../development/" class="md-nav__link">
        Development
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked>
      
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          Code reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Code reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1" checked>
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../">tasks</a>
          
            <label for="__nav_8_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_1_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_8_1">
          <span class="md-nav__icon md-icon"></span>
          tasks
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../_registration_utils/" class="md-nav__link">
        _registration_utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../_utils/" class="md-nav__link">
        _utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../_zarr_utils/" class="md-nav__link">
        _zarr_utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../apply_registration_to_image/" class="md-nav__link">
        apply_registration_to_image
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../calculate_registration_image_based/" class="md-nav__link">
        calculate_registration_image_based
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          cellpose_segmentation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        cellpose_segmentation
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.cellpose_segmentation" class="md-nav__link">
    cellpose_segmentation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.cellpose_segmentation.cellpose_segmentation" class="md-nav__link">
    cellpose_segmentation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.cellpose_segmentation.segment_ROI" class="md-nav__link">
    segment_ROI
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cellpose_utils/" class="md-nav__link">
        cellpose_utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cellvoyager_to_ome_zarr_compute/" class="md-nav__link">
        cellvoyager_to_ome_zarr_compute
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cellvoyager_to_ome_zarr_init/" class="md-nav__link">
        cellvoyager_to_ome_zarr_init
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cellvoyager_to_ome_zarr_init_multiplex/" class="md-nav__link">
        cellvoyager_to_ome_zarr_init_multiplex
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../copy_ome_zarr_hcs_plate/" class="md-nav__link">
        copy_ome_zarr_hcs_plate
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../find_registration_consensus/" class="md-nav__link">
        find_registration_consensus
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../illumination_correction/" class="md-nav__link">
        illumination_correction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../image_based_registration_hcs_init/" class="md-nav__link">
        image_based_registration_hcs_init
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../import_ome_zarr/" class="md-nav__link">
        import_ome_zarr
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../init_group_by_well_for_multiplexing/" class="md-nav__link">
        init_group_by_well_for_multiplexing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../io_models/" class="md-nav__link">
        io_models
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../napari_workflows_wrapper/" class="md-nav__link">
        napari_workflows_wrapper
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../projection/" class="md-nav__link">
        projection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../projection_utils/" class="md-nav__link">
        projection_utils
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_2" >
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../dev/">dev</a>
          
            <label for="__nav_8_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_2">
          <span class="md-nav__icon md-icon"></span>
          dev
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/create_manifest/" class="md-nav__link">
        create_manifest
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/deprecation_message/" class="md-nav__link">
        deprecation_message
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/lib_args_schemas/" class="md-nav__link">
        lib_args_schemas
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/lib_descriptions/" class="md-nav__link">
        lib_descriptions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/lib_pydantic_generatejsonschema/" class="md-nav__link">
        lib_pydantic_generatejsonschema
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/lib_signature_constraints/" class="md-nav__link">
        lib_signature_constraints
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/lib_task_docs/" class="md-nav__link">
        lib_task_docs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/lib_titles/" class="md-nav__link">
        lib_titles
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/task_list/" class="md-nav__link">
        task_list
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/task_models/" class="md-nav__link">
        task_models
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_3" >
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../cellvoyager/">cellvoyager</a>
          
            <label for="__nav_8_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_3">
          <span class="md-nav__icon md-icon"></span>
          cellvoyager
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cellvoyager/filenames/" class="md-nav__link">
        filenames
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cellvoyager/metadata/" class="md-nav__link">
        metadata
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cellvoyager/wells/" class="md-nav__link">
        wells
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../channels/" class="md-nav__link">
        channels
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../labels/" class="md-nav__link">
        labels
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../masked_loading/" class="md-nav__link">
        masked_loading
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_7" >
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../ngff/">ngff</a>
          
            <label for="__nav_8_7">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_7">
          <span class="md-nav__icon md-icon"></span>
          ngff
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ngff/specs/" class="md-nav__link">
        specs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ngff/zarr_utils/" class="md-nav__link">
        zarr_utils
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pyramids/" class="md-nav__link">
        pyramids
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_9" >
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../roi/">roi</a>
          
            <label for="__nav_8_9">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_9">
          <span class="md-nav__icon md-icon"></span>
          roi
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../roi/_overlaps_common/" class="md-nav__link">
        _overlaps_common
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../roi/load_region/" class="md-nav__link">
        load_region
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../roi/v1/" class="md-nav__link">
        v1
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../roi/v1_checks/" class="md-nav__link">
        v1_checks
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../roi/v1_overlaps/" class="md-nav__link">
        v1_overlaps
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_10" >
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../tables/">tables</a>
          
            <label for="__nav_8_10">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_10_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_10">
          <span class="md-nav__icon md-icon"></span>
          tables
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tables/v1/" class="md-nav__link">
        v1
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../upscale_array/" class="md-nav__link">
        upscale_array
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/" class="md-nav__link">
        utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../zarr_utils/" class="md-nav__link">
        zarr_utils
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/" class="md-nav__link">
        Changelog
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.cellpose_segmentation" class="md-nav__link">
    cellpose_segmentation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.cellpose_segmentation.cellpose_segmentation" class="md-nav__link">
    cellpose_segmentation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.cellpose_segmentation.segment_ROI" class="md-nav__link">
    segment_ROI
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>cellpose_segmentation</h1>

<div class="doc doc-object doc-module">



<a id="fractal_tasks_core.tasks.cellpose_segmentation"></a>
    <div class="doc doc-contents first">

      <p>Image segmentation via Cellpose library.</p>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="fractal_tasks_core.tasks.cellpose_segmentation.cellpose_segmentation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cellpose_segmentation</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">zarr_url</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">channel2</span><span class="o">=</span><span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">CellposeChannel2InputModel</span><span class="p">),</span> <span class="n">input_ROI_table</span><span class="o">=</span><span class="s1">&#39;FOV_ROI_table&#39;</span><span class="p">,</span> <span class="n">output_ROI_table</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_label_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">diameter_level0</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span> <span class="n">model_type</span><span class="o">=</span><span class="s1">&#39;cyto2&#39;</span><span class="p">,</span> <span class="n">pretrained_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">relabeling</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_masks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">advanced_cellpose_model_params</span><span class="o">=</span><span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">CellposeModelParams</span><span class="p">),</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#fractal_tasks_core.tasks.cellpose_segmentation.cellpose_segmentation" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

      <p>Run cellpose segmentation on the ROIs of a single OME-Zarr image.</p>


<table>
      <thead>
        <tr>
          <th><span class="doc-section-title">PARAMETER</span></th>
          <th><span>DESCRIPTION</span></th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>zarr_url</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Path or url to the individual OME-Zarr image to be processed.
(standard argument for Fractal tasks, managed by Fractal server).</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/stdtypes.html#str">str</a></code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>level</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Pyramid level of the image to be segmented. Choose <code>0</code> to
process at full resolution.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#int">int</a></code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>channel</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Primary channel for segmentation; requires either
<code>wavelength_id</code> (e.g. <code>A01_C01</code>) or <code>label</code> (e.g. <code>DAPI</code>), but not
both. Also contains normalization options. By default, data is
normalized so 0.0=1st percentile and 1.0=99th percentile of image
intensities in each channel.
This automatic normalization can lead to issues when the image to
be segmented is very sparse. You can turn off the default
rescaling. With the "custom" option, you can either provide your
own rescaling percentiles or fixed rescaling upper and lower
bound integers.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-internal" title="fractal_tasks_core.tasks.cellpose_utils.CellposeChannel1InputModel" href="../cellpose_utils/#fractal_tasks_core.tasks.cellpose_utils.CellposeChannel1InputModel">CellposeChannel1InputModel</a></code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>channel2</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Second channel for segmentation (in the same format as
<code>channel</code>). If specified, cellpose runs in dual channel mode.
For dual channel segmentation of cells, the first channel should
contain the membrane marker, the second channel should contain the
nuclear marker.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-internal" title="fractal_tasks_core.tasks.cellpose_utils.CellposeChannel2InputModel" href="../cellpose_utils/#fractal_tasks_core.tasks.cellpose_utils.CellposeChannel2InputModel">CellposeChannel2InputModel</a></code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code><span title="pydantic.Field">Field</span>(default_factory=<a class="autorefs autorefs-internal" title="fractal_tasks_core.tasks.cellpose_utils.CellposeChannel2InputModel" href="../cellpose_utils/#fractal_tasks_core.tasks.cellpose_utils.CellposeChannel2InputModel">CellposeChannel2InputModel</a>)</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>input_ROI_table</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Name of the ROI table over which the task loops to
apply Cellpose segmentation. Examples: <code>FOV_ROI_table</code> =&gt; loop over
the field of views, <code>organoid_ROI_table</code> =&gt; loop over the organoid
ROI table (generated by another task), <code>well_ROI_table</code> =&gt; process
the whole well as one image.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/stdtypes.html#str">str</a></code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>&#39;FOV_ROI_table&#39;</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>output_ROI_table</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>If provided, a ROI table with that name is created,
which will contain the bounding boxes of the newly segmented
labels. ROI tables should have <code>ROI</code> in their name.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/library/stdtypes.html#str">str</a>]</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>None</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>output_label_name</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Name of the output label image (e.g. <code>"organoids"</code>).</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/library/stdtypes.html#str">str</a>]</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>None</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>diameter_level0</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Expected diameter of the objects that should be
segmented in pixels at level 0. Initial diameter is rescaled using
the <code>level</code> that was selected. The rescaled value is passed as
the diameter to the <code>CellposeModel.eval</code> method.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#float">float</a></code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>30.0</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>model_type</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Parameter of <code>CellposeModel</code> class. Defines which model
should be used. Typical choices are <code>nuclei</code>, <code>cyto</code>, <code>cyto2</code>, etc.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" title="typing.Literal" href="https://docs.python.org/library/typing.html#typing.Literal">Literal</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/library/stdtypes.html#tuple">tuple</a>(<span title="cellpose.models.MODEL_NAMES">MODEL_NAMES</span>)]</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>&#39;cyto2&#39;</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>pretrained_model</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Parameter of <code>CellposeModel</code> class (takes
precedence over <code>model_type</code>). Allows you to specify the path of
a custom trained cellpose model.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/library/stdtypes.html#str">str</a>]</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>None</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>relabeling</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>If <code>True</code>, apply relabeling so that label values are
unique for all objects in the well.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#bool">bool</a></code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>True</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>use_masks</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>If <code>True</code>, try to use masked loading and fall back to
<code>use_masks=False</code> if the ROI table is not suitable. Masked
loading is relevant when only a subset of the bounding box should
actually be processed (e.g. running within <code>organoid_ROI_table</code>).</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#bool">bool</a></code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>True</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>advanced_cellpose_model_params</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Advanced Cellpose model parameters
that are passed to the Cellpose <code>model.eval</code> method.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-internal" title="fractal_tasks_core.tasks.cellpose_utils.CellposeModelParams" href="../cellpose_utils/#fractal_tasks_core.tasks.cellpose_utils.CellposeModelParams">CellposeModelParams</a></code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code><span title="pydantic.Field">Field</span>(default_factory=<a class="autorefs autorefs-internal" title="fractal_tasks_core.tasks.cellpose_utils.CellposeModelParams" href="../cellpose_utils/#fractal_tasks_core.tasks.cellpose_utils.CellposeModelParams">CellposeModelParams</a>)</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>overwrite</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>If <code>True</code>, overwrite the task output.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#bool">bool</a></code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>True</code>
                  </span>
              </p>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>fractal_tasks_core/tasks/cellpose_segmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@validate_call</span>
<span class="k">def</span> <span class="nf">cellpose_segmentation</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="c1"># Fractal parameters</span>
    <span class="n">zarr_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="c1"># Core parameters</span>
    <span class="n">level</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">channel</span><span class="p">:</span> <span class="n">CellposeChannel1InputModel</span><span class="p">,</span>
    <span class="n">channel2</span><span class="p">:</span> <span class="n">CellposeChannel2InputModel</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">CellposeChannel2InputModel</span>
    <span class="p">),</span>
    <span class="n">input_ROI_table</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;FOV_ROI_table&quot;</span><span class="p">,</span>
    <span class="n">output_ROI_table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_label_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="c1"># Cellpose-related arguments</span>
    <span class="n">diameter_level0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">30.0</span><span class="p">,</span>
    <span class="c1"># https://github.com/fractal-analytics-platform/fractal-tasks-core/issues/401 # noqa E501</span>
    <span class="n">model_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">MODEL_NAMES</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;cyto2&quot;</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
    <span class="n">pretrained_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">relabeling</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">use_masks</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">advanced_cellpose_model_params</span><span class="p">:</span> <span class="n">CellposeModelParams</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">CellposeModelParams</span>
    <span class="p">),</span>
    <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run cellpose segmentation on the ROIs of a single OME-Zarr image.</span>

<span class="sd">    Args:</span>
<span class="sd">        zarr_url: Path or url to the individual OME-Zarr image to be processed.</span>
<span class="sd">            (standard argument for Fractal tasks, managed by Fractal server).</span>
<span class="sd">        level: Pyramid level of the image to be segmented. Choose `0` to</span>
<span class="sd">            process at full resolution.</span>
<span class="sd">        channel: Primary channel for segmentation; requires either</span>
<span class="sd">            `wavelength_id` (e.g. `A01_C01`) or `label` (e.g. `DAPI`), but not</span>
<span class="sd">            both. Also contains normalization options. By default, data is</span>
<span class="sd">            normalized so 0.0=1st percentile and 1.0=99th percentile of image</span>
<span class="sd">            intensities in each channel.</span>
<span class="sd">            This automatic normalization can lead to issues when the image to</span>
<span class="sd">            be segmented is very sparse. You can turn off the default</span>
<span class="sd">            rescaling. With the &quot;custom&quot; option, you can either provide your</span>
<span class="sd">            own rescaling percentiles or fixed rescaling upper and lower</span>
<span class="sd">            bound integers.</span>
<span class="sd">        channel2: Second channel for segmentation (in the same format as</span>
<span class="sd">            `channel`). If specified, cellpose runs in dual channel mode.</span>
<span class="sd">            For dual channel segmentation of cells, the first channel should</span>
<span class="sd">            contain the membrane marker, the second channel should contain the</span>
<span class="sd">            nuclear marker.</span>
<span class="sd">        input_ROI_table: Name of the ROI table over which the task loops to</span>
<span class="sd">            apply Cellpose segmentation. Examples: `FOV_ROI_table` =&gt; loop over</span>
<span class="sd">            the field of views, `organoid_ROI_table` =&gt; loop over the organoid</span>
<span class="sd">            ROI table (generated by another task), `well_ROI_table` =&gt; process</span>
<span class="sd">            the whole well as one image.</span>
<span class="sd">        output_ROI_table: If provided, a ROI table with that name is created,</span>
<span class="sd">            which will contain the bounding boxes of the newly segmented</span>
<span class="sd">            labels. ROI tables should have `ROI` in their name.</span>
<span class="sd">        output_label_name: Name of the output label image (e.g. `&quot;organoids&quot;`).</span>
<span class="sd">        diameter_level0: Expected diameter of the objects that should be</span>
<span class="sd">            segmented in pixels at level 0. Initial diameter is rescaled using</span>
<span class="sd">            the `level` that was selected. The rescaled value is passed as</span>
<span class="sd">            the diameter to the `CellposeModel.eval` method.</span>
<span class="sd">        model_type: Parameter of `CellposeModel` class. Defines which model</span>
<span class="sd">            should be used. Typical choices are `nuclei`, `cyto`, `cyto2`, etc.</span>
<span class="sd">        pretrained_model: Parameter of `CellposeModel` class (takes</span>
<span class="sd">            precedence over `model_type`). Allows you to specify the path of</span>
<span class="sd">            a custom trained cellpose model.</span>
<span class="sd">        relabeling: If `True`, apply relabeling so that label values are</span>
<span class="sd">            unique for all objects in the well.</span>
<span class="sd">        use_masks: If `True`, try to use masked loading and fall back to</span>
<span class="sd">            `use_masks=False` if the ROI table is not suitable. Masked</span>
<span class="sd">            loading is relevant when only a subset of the bounding box should</span>
<span class="sd">            actually be processed (e.g. running within `organoid_ROI_table`).</span>
<span class="sd">        advanced_cellpose_model_params: Advanced Cellpose model parameters</span>
<span class="sd">            that are passed to the Cellpose `model.eval` method.</span>
<span class="sd">        overwrite: If `True`, overwrite the task output.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">zarr_url</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Preliminary checks on Cellpose model</span>
    <span class="k">if</span> <span class="n">pretrained_model</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pretrained_model</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pretrained_model</span><span class="si">=}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>

    <span class="c1"># Read attributes from NGFF metadata</span>
    <span class="n">ngff_image_meta</span> <span class="o">=</span> <span class="n">load_NgffImageMeta</span><span class="p">(</span><span class="n">zarr_url</span><span class="p">)</span>
    <span class="n">num_levels</span> <span class="o">=</span> <span class="n">ngff_image_meta</span><span class="o">.</span><span class="n">num_levels</span>
    <span class="n">coarsening_xy</span> <span class="o">=</span> <span class="n">ngff_image_meta</span><span class="o">.</span><span class="n">coarsening_xy</span>
    <span class="n">full_res_pxl_sizes_zyx</span> <span class="o">=</span> <span class="n">ngff_image_meta</span><span class="o">.</span><span class="n">get_pixel_sizes_zyx</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">actual_res_pxl_sizes_zyx</span> <span class="o">=</span> <span class="n">ngff_image_meta</span><span class="o">.</span><span class="n">get_pixel_sizes_zyx</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NGFF image has </span><span class="si">{</span><span class="n">num_levels</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NGFF image has </span><span class="si">{</span><span class="n">coarsening_xy</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;NGFF image has full-res pixel sizes </span><span class="si">{</span><span class="n">full_res_pxl_sizes_zyx</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;NGFF image has level-</span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2"> pixel sizes &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">actual_res_pxl_sizes_zyx</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Find channel index</span>
    <span class="n">omero_channel</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">get_omero_channel</span><span class="p">(</span><span class="n">zarr_url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">omero_channel</span><span class="p">:</span>
        <span class="n">ind_channel</span> <span class="o">=</span> <span class="n">omero_channel</span><span class="o">.</span><span class="n">index</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># Find channel index for second channel, if one is provided</span>
    <span class="k">if</span> <span class="n">channel2</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
        <span class="n">omero_channel_2</span> <span class="o">=</span> <span class="n">channel2</span><span class="o">.</span><span class="n">get_omero_channel</span><span class="p">(</span><span class="n">zarr_url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">omero_channel_2</span><span class="p">:</span>
            <span class="n">ind_channel_c2</span> <span class="o">=</span> <span class="n">omero_channel_2</span><span class="o">.</span><span class="n">index</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>

    <span class="c1"># Set channel label</span>
    <span class="k">if</span> <span class="n">output_label_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">channel_label</span> <span class="o">=</span> <span class="n">omero_channel</span><span class="o">.</span><span class="n">label</span>
            <span class="n">output_label_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;label_</span><span class="si">{</span><span class="n">channel_label</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
            <span class="n">output_label_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;label_</span><span class="si">{</span><span class="n">ind_channel</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># Load ZYX data</span>
    <span class="c1"># Workaround for #788: Only load channel index when there is a channel</span>
    <span class="c1"># dimension</span>
    <span class="k">if</span> <span class="n">ngff_image_meta</span><span class="o">.</span><span class="n">axes_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;c&quot;</span><span class="p">:</span>
        <span class="n">data_zyx</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">from_zarr</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">zarr_url</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">channel2</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Dual channel input was specified for an OME-Zarr image &quot;</span>
                <span class="s2">&quot;without a channel axis&quot;</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data_zyx</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">from_zarr</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">zarr_url</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[</span><span class="n">ind_channel</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">channel2</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="n">data_zyx_c2</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">from_zarr</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">zarr_url</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[</span><span class="n">ind_channel_c2</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Second channel: </span><span class="si">{</span><span class="n">data_zyx_c2</span><span class="o">.</span><span class="n">shape</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_zyx</span><span class="o">.</span><span class="n">shape</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Read ROI table</span>
    <span class="n">ROI_table_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">zarr_url</span><span class="si">}</span><span class="s2">/tables/</span><span class="si">{</span><span class="n">input_ROI_table</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">ROI_table</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">read_zarr</span><span class="p">(</span><span class="n">ROI_table_path</span><span class="p">)</span>

    <span class="c1"># Perform some checks on the ROI table</span>
    <span class="n">valid_ROI_table</span> <span class="o">=</span> <span class="n">is_ROI_table_valid</span><span class="p">(</span>
        <span class="n">table_path</span><span class="o">=</span><span class="n">ROI_table_path</span><span class="p">,</span> <span class="n">use_masks</span><span class="o">=</span><span class="n">use_masks</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">use_masks</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">valid_ROI_table</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;ROI table at </span><span class="si">{</span><span class="n">ROI_table_path</span><span class="si">}</span><span class="s2"> cannot be used for masked &quot;</span>
            <span class="s2">&quot;loading. Set use_masks=False.&quot;</span>
        <span class="p">)</span>
        <span class="n">use_masks</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">use_masks</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Create list of indices for 3D ROIs spanning the entire Z direction</span>
    <span class="n">list_indices</span> <span class="o">=</span> <span class="n">convert_ROI_table_to_indices</span><span class="p">(</span>
        <span class="n">ROI_table</span><span class="p">,</span>
        <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
        <span class="n">coarsening_xy</span><span class="o">=</span><span class="n">coarsening_xy</span><span class="p">,</span>
        <span class="n">full_res_pxl_sizes_zyx</span><span class="o">=</span><span class="n">full_res_pxl_sizes_zyx</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">check_valid_ROI_indices</span><span class="p">(</span><span class="n">list_indices</span><span class="p">,</span> <span class="n">input_ROI_table</span><span class="p">)</span>

    <span class="c1"># If we are not planning to use masked loading, fail for overlapping ROIs</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">use_masks</span><span class="p">:</span>
        <span class="n">overlap</span> <span class="o">=</span> <span class="n">find_overlaps_in_ROI_indices</span><span class="p">(</span><span class="n">list_indices</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">overlap</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;ROI indices created from </span><span class="si">{</span><span class="n">input_ROI_table</span><span class="si">}</span><span class="s2"> table have &quot;</span>
                <span class="s2">&quot;overlaps, but we are not using masked loading.&quot;</span>
            <span class="p">)</span>

    <span class="c1"># Select 2D/3D behavior and set some parameters</span>
    <span class="n">do_3D</span> <span class="o">=</span> <span class="n">data_zyx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_zyx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">if</span> <span class="n">do_3D</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">advanced_cellpose_model_params</span><span class="o">.</span><span class="n">anisotropy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Compute anisotropy as pixel_size_z/pixel_size_x</span>
            <span class="n">advanced_cellpose_model_params</span><span class="o">.</span><span class="n">anisotropy</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">actual_res_pxl_sizes_zyx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">actual_res_pxl_sizes_zyx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Anisotropy: </span><span class="si">{</span><span class="n">advanced_cellpose_model_params</span><span class="o">.</span><span class="n">anisotropy</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Rescale datasets (only relevant for level&gt;0)</span>
    <span class="c1"># Workaround for #788</span>
    <span class="k">if</span> <span class="n">ngff_image_meta</span><span class="o">.</span><span class="n">axes_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;c&quot;</span><span class="p">:</span>
        <span class="n">new_datasets</span> <span class="o">=</span> <span class="n">rescale_datasets</span><span class="p">(</span>
            <span class="n">datasets</span><span class="o">=</span><span class="p">[</span><span class="n">ds</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">ngff_image_meta</span><span class="o">.</span><span class="n">datasets</span><span class="p">],</span>
            <span class="n">coarsening_xy</span><span class="o">=</span><span class="n">coarsening_xy</span><span class="p">,</span>
            <span class="n">reference_level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
            <span class="n">remove_channel_axis</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_datasets</span> <span class="o">=</span> <span class="n">rescale_datasets</span><span class="p">(</span>
            <span class="n">datasets</span><span class="o">=</span><span class="p">[</span><span class="n">ds</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">ngff_image_meta</span><span class="o">.</span><span class="n">datasets</span><span class="p">],</span>
            <span class="n">coarsening_xy</span><span class="o">=</span><span class="n">coarsening_xy</span><span class="p">,</span>
            <span class="n">reference_level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
            <span class="n">remove_channel_axis</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">label_attrs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;image-label&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">__OME_NGFF_VERSION__</span><span class="p">,</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="s2">&quot;../../&quot;</span><span class="p">},</span>
        <span class="p">},</span>
        <span class="s2">&quot;multiscales&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">output_label_name</span><span class="p">,</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">__OME_NGFF_VERSION__</span><span class="p">,</span>
                <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">ngff_image_meta</span><span class="o">.</span><span class="n">multiscale</span><span class="o">.</span><span class="n">axes</span>
                    <span class="k">if</span> <span class="n">ax</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;channel&quot;</span>
                <span class="p">],</span>
                <span class="s2">&quot;datasets&quot;</span><span class="p">:</span> <span class="n">new_datasets</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">],</span>
    <span class="p">}</span>

    <span class="n">image_group</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">zarr_url</span><span class="p">)</span>
    <span class="n">label_group</span> <span class="o">=</span> <span class="n">prepare_label_group</span><span class="p">(</span>
        <span class="n">image_group</span><span class="p">,</span>
        <span class="n">output_label_name</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span>
        <span class="n">label_attrs</span><span class="o">=</span><span class="n">label_attrs</span><span class="p">,</span>
        <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Helper function `prepare_label_group` returned </span><span class="si">{</span><span class="n">label_group</span><span class="si">=}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output label path: </span><span class="si">{</span><span class="n">zarr_url</span><span class="si">}</span><span class="s2">/labels/</span><span class="si">{</span><span class="n">output_label_name</span><span class="si">}</span><span class="s2">/0&quot;</span><span class="p">)</span>
    <span class="n">store</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">FSStore</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">zarr_url</span><span class="si">}</span><span class="s2">/labels/</span><span class="si">{</span><span class="n">output_label_name</span><span class="si">}</span><span class="s2">/0&quot;</span><span class="p">)</span>
    <span class="n">label_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span>

    <span class="c1"># Ensure that all output shapes &amp; chunks are 3D (for 2D data: (1, y, x))</span>
    <span class="c1"># https://github.com/fractal-analytics-platform/fractal-tasks-core/issues/398</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">data_zyx</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="n">data_zyx</span><span class="o">.</span><span class="n">chunksize</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">chunks</span><span class="p">)</span>
    <span class="n">mask_zarr</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>
        <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">label_dtype</span><span class="p">,</span>
        <span class="n">store</span><span class="o">=</span><span class="n">store</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">dimension_separator</span><span class="o">=</span><span class="s2">&quot;/&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;mask will have shape </span><span class="si">{</span><span class="n">data_zyx</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;and chunks </span><span class="si">{</span><span class="n">data_zyx</span><span class="o">.</span><span class="n">chunks</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Initialize cellpose</span>
    <span class="n">gpu</span> <span class="o">=</span> <span class="n">advanced_cellpose_model_params</span><span class="o">.</span><span class="n">use_gpu</span> <span class="ow">and</span> <span class="n">cellpose</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">pretrained_model</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CellposeModel</span><span class="p">(</span>
            <span class="n">gpu</span><span class="o">=</span><span class="n">gpu</span><span class="p">,</span> <span class="n">pretrained_model</span><span class="o">=</span><span class="n">pretrained_model</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CellposeModel</span><span class="p">(</span><span class="n">gpu</span><span class="o">=</span><span class="n">gpu</span><span class="p">,</span> <span class="n">model_type</span><span class="o">=</span><span class="n">model_type</span><span class="p">)</span>

    <span class="c1"># Initialize other things</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Start cellpose_segmentation task for </span><span class="si">{</span><span class="n">zarr_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;relabeling: </span><span class="si">{</span><span class="n">relabeling</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;do_3D: </span><span class="si">{</span><span class="n">do_3D</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;use_gpu: </span><span class="si">{</span><span class="n">gpu</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;level: </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;model_type: </span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pretrained_model: </span><span class="si">{</span><span class="n">pretrained_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;anisotropy: </span><span class="si">{</span><span class="n">advanced_cellpose_model_params</span><span class="o">.</span><span class="n">anisotropy</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Total well shape/chunks:&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_zyx</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_zyx</span><span class="o">.</span><span class="n">chunks</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">channel2</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dual channel input for cellpose model&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_zyx_c2</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_zyx_c2</span><span class="o">.</span><span class="n">chunks</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Counters for relabeling</span>
    <span class="n">num_labels_tot</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;num_labels_tot&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

    <span class="c1"># Iterate over ROIs</span>
    <span class="n">num_ROIs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_indices</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output_ROI_table</span><span class="p">:</span>
        <span class="n">bbox_dataframe_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Now starting loop over </span><span class="si">{</span><span class="n">num_ROIs</span><span class="si">}</span><span class="s2"> ROIs&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i_ROI</span><span class="p">,</span> <span class="n">indices</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">list_indices</span><span class="p">):</span>
        <span class="c1"># Define region</span>
        <span class="n">s_z</span><span class="p">,</span> <span class="n">e_z</span><span class="p">,</span> <span class="n">s_y</span><span class="p">,</span> <span class="n">e_y</span><span class="p">,</span> <span class="n">s_x</span><span class="p">,</span> <span class="n">e_x</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[:]</span>
        <span class="n">region</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">slice</span><span class="p">(</span><span class="n">s_z</span><span class="p">,</span> <span class="n">e_z</span><span class="p">),</span>
            <span class="nb">slice</span><span class="p">(</span><span class="n">s_y</span><span class="p">,</span> <span class="n">e_y</span><span class="p">),</span>
            <span class="nb">slice</span><span class="p">(</span><span class="n">s_x</span><span class="p">,</span> <span class="n">e_x</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Now processing ROI </span><span class="si">{</span><span class="n">i_ROI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">num_ROIs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Prepare single-channel or dual-channel input for cellpose</span>
        <span class="k">if</span> <span class="n">channel2</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="c1"># Dual channel mode, first channel is the membrane channel</span>
            <span class="n">img_1</span> <span class="o">=</span> <span class="n">load_region</span><span class="p">(</span>
                <span class="n">data_zyx</span><span class="p">,</span>
                <span class="n">region</span><span class="p">,</span>
                <span class="n">compute</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">return_as_3D</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">img_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="o">*</span><span class="n">img_1</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="n">img_np</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">img_1</span>
            <span class="n">img_np</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">load_region</span><span class="p">(</span>
                <span class="n">data_zyx_c2</span><span class="p">,</span>
                <span class="n">region</span><span class="p">,</span>
                <span class="n">compute</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">return_as_3D</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span>
                <span class="n">load_region</span><span class="p">(</span><span class="n">data_zyx</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_as_3D</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Prepare keyword arguments for segment_ROI function</span>
        <span class="n">kwargs_segment_ROI</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">num_labels_tot</span><span class="o">=</span><span class="n">num_labels_tot</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">channels</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span>
            <span class="n">do_3D</span><span class="o">=</span><span class="n">do_3D</span><span class="p">,</span>
            <span class="n">label_dtype</span><span class="o">=</span><span class="n">label_dtype</span><span class="p">,</span>
            <span class="n">diameter</span><span class="o">=</span><span class="n">diameter_level0</span> <span class="o">/</span> <span class="n">coarsening_xy</span><span class="o">**</span><span class="n">level</span><span class="p">,</span>
            <span class="n">normalize</span><span class="o">=</span><span class="n">channel</span><span class="o">.</span><span class="n">normalize</span><span class="p">,</span>
            <span class="n">normalize2</span><span class="o">=</span><span class="n">channel2</span><span class="o">.</span><span class="n">normalize</span><span class="p">,</span>
            <span class="n">relabeling</span><span class="o">=</span><span class="n">relabeling</span><span class="p">,</span>
            <span class="n">advanced_cellpose_model_params</span><span class="o">=</span><span class="n">advanced_cellpose_model_params</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Prepare keyword arguments for preprocessing function</span>
        <span class="n">preprocessing_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">use_masks</span><span class="p">:</span>
            <span class="n">preprocessing_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
                <span class="n">current_label_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">zarr_url</span><span class="si">}</span><span class="s2">/labels/</span><span class="si">{</span><span class="n">output_label_name</span><span class="si">}</span><span class="s2">/0&quot;</span><span class="p">,</span>
                <span class="n">ROI_table_path</span><span class="o">=</span><span class="n">ROI_table_path</span><span class="p">,</span>
                <span class="n">ROI_positional_index</span><span class="o">=</span><span class="n">i_ROI</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Call segment_ROI through the masked-loading wrapper, which includes</span>
        <span class="c1"># pre/post-processing functions if needed</span>
        <span class="n">new_label_img</span> <span class="o">=</span> <span class="n">masked_loading_wrapper</span><span class="p">(</span>
            <span class="n">image_array</span><span class="o">=</span><span class="n">img_np</span><span class="p">,</span>
            <span class="n">function</span><span class="o">=</span><span class="n">segment_ROI</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs_segment_ROI</span><span class="p">,</span>
            <span class="n">use_masks</span><span class="o">=</span><span class="n">use_masks</span><span class="p">,</span>
            <span class="n">preprocessing_kwargs</span><span class="o">=</span><span class="n">preprocessing_kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">output_ROI_table</span><span class="p">:</span>
            <span class="n">bbox_df</span> <span class="o">=</span> <span class="n">array_to_bounding_box_table</span><span class="p">(</span>
                <span class="n">new_label_img</span><span class="p">,</span>
                <span class="n">actual_res_pxl_sizes_zyx</span><span class="p">,</span>
                <span class="n">origin_zyx</span><span class="o">=</span><span class="p">(</span><span class="n">s_z</span><span class="p">,</span> <span class="n">s_y</span><span class="p">,</span> <span class="n">s_x</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="n">bbox_dataframe_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bbox_df</span><span class="p">)</span>

        <span class="c1"># Compute and store 0-th level to disk</span>
        <span class="n">da</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_label_img</span><span class="p">)</span><span class="o">.</span><span class="n">to_zarr</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="n">mask_zarr</span><span class="p">,</span>
            <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
            <span class="n">compute</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;End cellpose_segmentation task for </span><span class="si">{</span><span class="n">zarr_url</span><span class="si">}</span><span class="s2">, &quot;</span>
        <span class="s2">&quot;now building pyramids.&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Starting from on-disk highest-resolution data, build and write to disk a</span>
    <span class="c1"># pyramid of coarser levels</span>
    <span class="n">build_pyramid</span><span class="p">(</span>
        <span class="n">zarrurl</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">zarr_url</span><span class="si">}</span><span class="s2">/labels/</span><span class="si">{</span><span class="n">output_label_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span>
        <span class="n">num_levels</span><span class="o">=</span><span class="n">num_levels</span><span class="p">,</span>
        <span class="n">coarsening_xy</span><span class="o">=</span><span class="n">coarsening_xy</span><span class="p">,</span>
        <span class="n">chunksize</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span>
        <span class="n">aggregation_function</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;End building pyramids&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output_ROI_table</span><span class="p">:</span>
        <span class="n">bbox_table</span> <span class="o">=</span> <span class="n">create_roi_table_from_df_list</span><span class="p">(</span><span class="n">bbox_dataframe_list</span><span class="p">)</span>

        <span class="c1"># Write to zarr group</span>
        <span class="n">image_group</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">zarr_url</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Now writing bounding-box ROI table to &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">zarr_url</span><span class="si">}</span><span class="s2">/tables/</span><span class="si">{</span><span class="n">output_ROI_table</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">table_attrs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;masking_roi_table&quot;</span><span class="p">,</span>
            <span class="s2">&quot;region&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;../labels/</span><span class="si">{</span><span class="n">output_label_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span>
            <span class="s2">&quot;instance_key&quot;</span><span class="p">:</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">write_table</span><span class="p">(</span>
            <span class="n">image_group</span><span class="p">,</span>
            <span class="n">output_ROI_table</span><span class="p">,</span>
            <span class="n">bbox_table</span><span class="p">,</span>
            <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span>
            <span class="n">table_attrs</span><span class="o">=</span><span class="n">table_attrs</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="fractal_tasks_core.tasks.cellpose_segmentation.segment_ROI" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">segment_ROI</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">num_labels_tot</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">do_3D</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">diameter</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="n">CellposeCustomNormalizer</span><span class="p">(),</span> <span class="n">normalize2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label_dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">relabeling</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">advanced_cellpose_model_params</span><span class="o">=</span><span class="n">CellposeModelParams</span><span class="p">())</span></code>

<a href="#fractal_tasks_core.tasks.cellpose_segmentation.segment_ROI" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

      <p>Internal function that runs Cellpose segmentation for a single ROI.</p>


<table>
      <thead>
        <tr>
          <th><span class="doc-section-title">PARAMETER</span></th>
          <th><span>DESCRIPTION</span></th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>x</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>4D numpy array.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" title="numpy.ndarray" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray">ndarray</a></code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>num_labels_tot</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Number of labels already in total image. Used for
relabeling purposes. Using a dict to have a mutable object that
can be edited from within the function without having to be passed
back through the masked_loading_wrapper.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/stdtypes.html#dict">dict</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/library/stdtypes.html#str">str</a>, <a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#int">int</a>]</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>model</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>An instance of <code>models.CellposeModel</code>.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><span title="cellpose.models.CellposeModel">CellposeModel</span></code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>None</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>do_3D</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>If <code>True</code>, cellpose runs in 3D mode: runs on xy, xz &amp; yz planes,
then averages the flows.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#bool">bool</a></code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>True</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>channels</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Which channels to use. If only one channel is provided, <code>[0,
0]</code> should be used. If two channels are provided (the first
dimension of <code>x</code> has length of 2), <code>[1, 2]</code> should be used
(<code>x[0, :, :,:]</code> contains the membrane channel and
<code>x[1, :, :, :]</code> contains the nuclear channel).</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#int">int</a>]</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>[0, 0]</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>diameter</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Expected object diameter in pixels for cellpose.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#float">float</a></code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>30.0</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>normalize</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>By default, data is normalized so 0.0=1st percentile and
1.0=99th percentile of image intensities in each channel.
This automatic normalization can lead to issues when the image to
be segmented is very sparse. You can turn off the default
rescaling. With the "custom" option, you can either provide your
own rescaling percentiles or fixed rescaling upper and lower
bound integers.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-internal" title="fractal_tasks_core.tasks.cellpose_utils.CellposeCustomNormalizer" href="../cellpose_utils/#fractal_tasks_core.tasks.cellpose_utils.CellposeCustomNormalizer">CellposeCustomNormalizer</a></code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code><a class="autorefs autorefs-internal" title="fractal_tasks_core.tasks.cellpose_utils.CellposeCustomNormalizer" href="../cellpose_utils/#fractal_tasks_core.tasks.cellpose_utils.CellposeCustomNormalizer">CellposeCustomNormalizer</a>()</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>normalize2</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Normalization options for channel 2. If one channel is
normalized with default settings, both channels need to be
normalized with default settings.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-internal" title="fractal_tasks_core.tasks.cellpose_utils.CellposeCustomNormalizer" href="../cellpose_utils/#fractal_tasks_core.tasks.cellpose_utils.CellposeCustomNormalizer">CellposeCustomNormalizer</a>]</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>None</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>label_dtype</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Label images are cast into this <code>np.dtype</code>.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" title="numpy.dtype" href="https://numpy.org/doc/stable/reference/generated/numpy.dtype.html#numpy.dtype">dtype</a>]</code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>None</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>relabeling</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Whether relabeling based on num_labels_tot is performed.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#bool">bool</a></code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>True</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>advanced_cellpose_model_params</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Advanced Cellpose model parameters
that are passed to the Cellpose <code>model.eval</code> method.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-internal" title="fractal_tasks_core.tasks.cellpose_utils.CellposeModelParams" href="../cellpose_utils/#fractal_tasks_core.tasks.cellpose_utils.CellposeModelParams">CellposeModelParams</a></code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code><a class="autorefs autorefs-internal" title="fractal_tasks_core.tasks.cellpose_utils.CellposeModelParams" href="../cellpose_utils/#fractal_tasks_core.tasks.cellpose_utils.CellposeModelParams">CellposeModelParams</a>()</code>
                  </span>
              </p>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>fractal_tasks_core/tasks/cellpose_segmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">segment_ROI</span><span class="p">(</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">num_labels_tot</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">CellposeModel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">do_3D</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">channels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="n">diameter</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">30.0</span><span class="p">,</span>
    <span class="n">normalize</span><span class="p">:</span> <span class="n">CellposeCustomNormalizer</span> <span class="o">=</span> <span class="n">CellposeCustomNormalizer</span><span class="p">(),</span>
    <span class="n">normalize2</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CellposeCustomNormalizer</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">label_dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">relabeling</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">advanced_cellpose_model_params</span><span class="p">:</span> <span class="n">CellposeModelParams</span> <span class="o">=</span> <span class="n">CellposeModelParams</span><span class="p">(),</span>  <span class="c1"># noqa: E501</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Internal function that runs Cellpose segmentation for a single ROI.</span>

<span class="sd">    Args:</span>
<span class="sd">        x: 4D numpy array.</span>
<span class="sd">        num_labels_tot: Number of labels already in total image. Used for</span>
<span class="sd">            relabeling purposes. Using a dict to have a mutable object that</span>
<span class="sd">            can be edited from within the function without having to be passed</span>
<span class="sd">            back through the masked_loading_wrapper.</span>
<span class="sd">        model: An instance of `models.CellposeModel`.</span>
<span class="sd">        do_3D: If `True`, cellpose runs in 3D mode: runs on xy, xz &amp; yz planes,</span>
<span class="sd">            then averages the flows.</span>
<span class="sd">        channels: Which channels to use. If only one channel is provided, `[0,</span>
<span class="sd">            0]` should be used. If two channels are provided (the first</span>
<span class="sd">            dimension of `x` has length of 2), `[1, 2]` should be used</span>
<span class="sd">            (`x[0, :, :,:]` contains the membrane channel and</span>
<span class="sd">            `x[1, :, :, :]` contains the nuclear channel).</span>
<span class="sd">        diameter: Expected object diameter in pixels for cellpose.</span>
<span class="sd">        normalize: By default, data is normalized so 0.0=1st percentile and</span>
<span class="sd">            1.0=99th percentile of image intensities in each channel.</span>
<span class="sd">            This automatic normalization can lead to issues when the image to</span>
<span class="sd">            be segmented is very sparse. You can turn off the default</span>
<span class="sd">            rescaling. With the &quot;custom&quot; option, you can either provide your</span>
<span class="sd">            own rescaling percentiles or fixed rescaling upper and lower</span>
<span class="sd">            bound integers.</span>
<span class="sd">        normalize2: Normalization options for channel 2. If one channel is</span>
<span class="sd">            normalized with default settings, both channels need to be</span>
<span class="sd">            normalized with default settings.</span>
<span class="sd">        label_dtype: Label images are cast into this `np.dtype`.</span>
<span class="sd">        relabeling: Whether relabeling based on num_labels_tot is performed.</span>
<span class="sd">        advanced_cellpose_model_params: Advanced Cellpose model parameters</span>
<span class="sd">            that are passed to the Cellpose `model.eval` method.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Write some debugging info</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;[segment_ROI] START |&quot;</span>
        <span class="sa">f</span><span class="s2">&quot; x: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> |&quot;</span>
        <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">do_3D</span><span class="si">=}</span><span class="s2"> |&quot;</span>
        <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">diam_mean</span><span class="si">=}</span><span class="s2"> |&quot;</span>
        <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">diameter</span><span class="si">=}</span><span class="s2"> |&quot;</span>
        <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">advanced_cellpose_model_params</span><span class="o">.</span><span class="n">flow_threshold</span><span class="si">=}</span><span class="s2"> |&quot;</span>
        <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">normalize</span><span class="o">.</span><span class="n">type</span><span class="si">=}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">_normalize_cellpose_channels</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="n">normalize2</span><span class="p">)</span>

    <span class="c1"># Actual labeling</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">mask</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span>
        <span class="n">x</span><span class="p">,</span>
        <span class="n">channels</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span>
        <span class="n">do_3D</span><span class="o">=</span><span class="n">do_3D</span><span class="p">,</span>
        <span class="n">net_avg</span><span class="o">=</span><span class="n">advanced_cellpose_model_params</span><span class="o">.</span><span class="n">net_avg</span><span class="p">,</span>
        <span class="n">augment</span><span class="o">=</span><span class="n">advanced_cellpose_model_params</span><span class="o">.</span><span class="n">augment</span><span class="p">,</span>
        <span class="n">diameter</span><span class="o">=</span><span class="n">diameter</span><span class="p">,</span>
        <span class="n">anisotropy</span><span class="o">=</span><span class="n">advanced_cellpose_model_params</span><span class="o">.</span><span class="n">anisotropy</span><span class="p">,</span>
        <span class="n">cellprob_threshold</span><span class="o">=</span><span class="n">advanced_cellpose_model_params</span><span class="o">.</span><span class="n">cellprob_threshold</span><span class="p">,</span>
        <span class="n">flow_threshold</span><span class="o">=</span><span class="n">advanced_cellpose_model_params</span><span class="o">.</span><span class="n">flow_threshold</span><span class="p">,</span>
        <span class="n">normalize</span><span class="o">=</span><span class="n">normalize</span><span class="o">.</span><span class="n">cellpose_normalize</span><span class="p">,</span>
        <span class="n">min_size</span><span class="o">=</span><span class="n">advanced_cellpose_model_params</span><span class="o">.</span><span class="n">min_size</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">advanced_cellpose_model_params</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">invert</span><span class="o">=</span><span class="n">advanced_cellpose_model_params</span><span class="o">.</span><span class="n">invert</span><span class="p">,</span>
        <span class="n">tile</span><span class="o">=</span><span class="n">advanced_cellpose_model_params</span><span class="o">.</span><span class="n">tile</span><span class="p">,</span>
        <span class="n">tile_overlap</span><span class="o">=</span><span class="n">advanced_cellpose_model_params</span><span class="o">.</span><span class="n">tile_overlap</span><span class="p">,</span>
        <span class="n">resample</span><span class="o">=</span><span class="n">advanced_cellpose_model_params</span><span class="o">.</span><span class="n">resample</span><span class="p">,</span>
        <span class="n">interp</span><span class="o">=</span><span class="n">advanced_cellpose_model_params</span><span class="o">.</span><span class="n">interp</span><span class="p">,</span>
        <span class="n">stitch_threshold</span><span class="o">=</span><span class="n">advanced_cellpose_model_params</span><span class="o">.</span><span class="n">stitch_threshold</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">label_dtype</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># If we get a 2D image, we still return it as a 3D array</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

    <span class="c1"># Write some debugging info</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;[segment_ROI] END   |&quot;</span>
        <span class="sa">f</span><span class="s2">&quot; Elapsed: </span><span class="si">{</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> s |&quot;</span>  <span class="c1"># noqa</span>
        <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="si">=}</span><span class="s2">,&quot;</span>
        <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">mask</span><span class="o">.</span><span class="n">dtype</span><span class="si">=}</span><span class="s2"> (then </span><span class="si">{</span><span class="n">label_dtype</span><span class="si">}</span><span class="s2">),&quot;</span>
        <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="si">=}</span><span class="s2"> |&quot;</span>
        <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">diam_mean</span><span class="si">=}</span><span class="s2"> |&quot;</span>
        <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">diameter</span><span class="si">=}</span><span class="s2"> |&quot;</span>
        <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">advanced_cellpose_model_params</span><span class="o">.</span><span class="n">flow_threshold</span><span class="si">=}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Shift labels and update relabeling counters</span>
    <span class="k">if</span> <span class="n">relabeling</span><span class="p">:</span>
        <span class="n">num_labels_roi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">num_labels_tot</span><span class="p">[</span><span class="s2">&quot;num_labels_tot&quot;</span><span class="p">]</span>
        <span class="n">num_labels_tot</span><span class="p">[</span><span class="s2">&quot;num_labels_tot&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">num_labels_roi</span>

        <span class="c1"># Write some logs</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ROI had </span><span class="si">{</span><span class="n">num_labels_roi</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">num_labels_tot</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Check that total number of labels is under control</span>
        <span class="k">if</span> <span class="n">num_labels_tot</span><span class="p">[</span><span class="s2">&quot;num_labels_tot&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">label_dtype</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;ERROR in re-labeling:&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Reached </span><span class="si">{</span><span class="n">num_labels_tot</span><span class="si">}</span><span class="s2"> labels, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;but dtype=</span><span class="si">{</span><span class="n">label_dtype</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">mask</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
       Copyright 2024
University of Zurich
(see <u><a href="https://github.com/fractal-analytics-platform/fractal-tasks-core/blob/main/LICENSE">
LICENSE
</a></u>).

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["content.code.annotate", "content.code.copy"], "search": "../../../../assets/javascripts/workers/search.74e28a9f.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.220ee61c.min.js"></script>
      
        
          <script src="../../../../javascripts/mathjax.js"></script>
        
      
        
          <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
        
      
        
          <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        
      
    
  </body>
</html>