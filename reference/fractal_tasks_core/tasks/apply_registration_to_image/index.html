
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../_zarr_utils/">
      
      
        <link rel="next" href="../calculate_registration_image_based/">
      
      <link rel="icon" href="https://raw.githubusercontent.com/fractal-analytics-platform/fractal-logos/refs/heads/main/common/fractal_favicon.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-9.1.21">
    
    
      
        <title>apply_registration_to_image - Fractal Tasks Core</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.eebd395e.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../../extra.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="light-blue">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#fractal_tasks_core.tasks.apply_registration_to_image" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="Fractal Tasks Core" class="md-header__button md-logo" aria-label="Fractal Tasks Core" data-md-component="logo">
      
  <img src="https://raw.githubusercontent.com/fractal-analytics-platform/fractal-logos/refs/heads/main/common/fractal_logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Fractal Tasks Core
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              apply_registration_to_image
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="light-blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="light-blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
              </label>
            
          
        </form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/fractal-analytics-platform/fractal-tasks-core" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    fractal-tasks-core
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Fractal Tasks Core" class="md-nav__button md-logo" aria-label="Fractal Tasks Core" data-md-component="logo">
      
  <img src="https://raw.githubusercontent.com/fractal-analytics-platform/fractal-logos/refs/heads/main/common/fractal_logo.png" alt="logo">

    </a>
    Fractal Tasks Core
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/fractal-analytics-platform/fractal-tasks-core" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    fractal-tasks-core
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        Home page
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../install/" class="md-nav__link">
        Install
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../run_tasks/">Run tasks</a>
          
            <label for="__nav_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Run tasks
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../run_tasks/tasks_in_fractal/" class="md-nav__link">
        Within Fractal
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../run_tasks/tasks_in_scripts/" class="md-nav__link">
        From Python scripts
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../all_tasks/" class="md-nav__link">
        Task list
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../tables/" class="md-nav__link">
        Table specs
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../custom_task/" class="md-nav__link">
        Write custom tasks
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../development/" class="md-nav__link">
        Development
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked>
      
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          Code reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Code reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1" checked>
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../">tasks</a>
          
            <label for="__nav_8_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_1_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_8_1">
          <span class="md-nav__icon md-icon"></span>
          tasks
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../_registration_utils/" class="md-nav__link">
        _registration_utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../_utils/" class="md-nav__link">
        _utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../_zarr_utils/" class="md-nav__link">
        _zarr_utils
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          apply_registration_to_image
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        apply_registration_to_image
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.apply_registration_to_image" class="md-nav__link">
    apply_registration_to_image
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.apply_registration_to_image.apply_registration_to_image" class="md-nav__link">
    apply_registration_to_image
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.apply_registration_to_image.write_registered_zarr" class="md-nav__link">
    write_registered_zarr
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../calculate_registration_image_based/" class="md-nav__link">
        calculate_registration_image_based
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cellpose_segmentation/" class="md-nav__link">
        cellpose_segmentation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cellpose_utils/" class="md-nav__link">
        cellpose_utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cellvoyager_to_ome_zarr_compute/" class="md-nav__link">
        cellvoyager_to_ome_zarr_compute
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cellvoyager_to_ome_zarr_init/" class="md-nav__link">
        cellvoyager_to_ome_zarr_init
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cellvoyager_to_ome_zarr_init_multiplex/" class="md-nav__link">
        cellvoyager_to_ome_zarr_init_multiplex
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../copy_ome_zarr_hcs_plate/" class="md-nav__link">
        copy_ome_zarr_hcs_plate
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../find_registration_consensus/" class="md-nav__link">
        find_registration_consensus
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../illumination_correction/" class="md-nav__link">
        illumination_correction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../image_based_registration_hcs_init/" class="md-nav__link">
        image_based_registration_hcs_init
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../import_ome_zarr/" class="md-nav__link">
        import_ome_zarr
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../init_group_by_well_for_multiplexing/" class="md-nav__link">
        init_group_by_well_for_multiplexing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../io_models/" class="md-nav__link">
        io_models
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../napari_workflows_wrapper/" class="md-nav__link">
        napari_workflows_wrapper
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../projection/" class="md-nav__link">
        projection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../projection_utils/" class="md-nav__link">
        projection_utils
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_2" >
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../dev/">dev</a>
          
            <label for="__nav_8_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_2">
          <span class="md-nav__icon md-icon"></span>
          dev
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/create_manifest/" class="md-nav__link">
        create_manifest
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/deprecation_message/" class="md-nav__link">
        deprecation_message
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/lib_args_schemas/" class="md-nav__link">
        lib_args_schemas
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/lib_descriptions/" class="md-nav__link">
        lib_descriptions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/lib_pydantic_generatejsonschema/" class="md-nav__link">
        lib_pydantic_generatejsonschema
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/lib_signature_constraints/" class="md-nav__link">
        lib_signature_constraints
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/lib_task_docs/" class="md-nav__link">
        lib_task_docs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/lib_titles/" class="md-nav__link">
        lib_titles
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/task_list/" class="md-nav__link">
        task_list
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/task_models/" class="md-nav__link">
        task_models
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_3" >
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../cellvoyager/">cellvoyager</a>
          
            <label for="__nav_8_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_3">
          <span class="md-nav__icon md-icon"></span>
          cellvoyager
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cellvoyager/filenames/" class="md-nav__link">
        filenames
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cellvoyager/metadata/" class="md-nav__link">
        metadata
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cellvoyager/wells/" class="md-nav__link">
        wells
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../channels/" class="md-nav__link">
        channels
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../labels/" class="md-nav__link">
        labels
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../masked_loading/" class="md-nav__link">
        masked_loading
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_7" >
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../ngff/">ngff</a>
          
            <label for="__nav_8_7">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_7">
          <span class="md-nav__icon md-icon"></span>
          ngff
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ngff/specs/" class="md-nav__link">
        specs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ngff/zarr_utils/" class="md-nav__link">
        zarr_utils
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pyramids/" class="md-nav__link">
        pyramids
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_9" >
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../roi/">roi</a>
          
            <label for="__nav_8_9">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_9">
          <span class="md-nav__icon md-icon"></span>
          roi
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../roi/_overlaps_common/" class="md-nav__link">
        _overlaps_common
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../roi/load_region/" class="md-nav__link">
        load_region
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../roi/v1/" class="md-nav__link">
        v1
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../roi/v1_checks/" class="md-nav__link">
        v1_checks
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../roi/v1_overlaps/" class="md-nav__link">
        v1_overlaps
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_10" >
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../tables/">tables</a>
          
            <label for="__nav_8_10">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_10_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_10">
          <span class="md-nav__icon md-icon"></span>
          tables
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tables/v1/" class="md-nav__link">
        v1
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../upscale_array/" class="md-nav__link">
        upscale_array
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/" class="md-nav__link">
        utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../zarr_utils/" class="md-nav__link">
        zarr_utils
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/" class="md-nav__link">
        Changelog
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.apply_registration_to_image" class="md-nav__link">
    apply_registration_to_image
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.apply_registration_to_image.apply_registration_to_image" class="md-nav__link">
    apply_registration_to_image
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.apply_registration_to_image.write_registered_zarr" class="md-nav__link">
    write_registered_zarr
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>apply_registration_to_image</h1>

<div class="doc doc-object doc-module">



<a id="fractal_tasks_core.tasks.apply_registration_to_image"></a>
    <div class="doc doc-contents first">

      <p>Calculates translation for 2D image-based registration</p>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="fractal_tasks_core.tasks.apply_registration_to_image.apply_registration_to_image" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">apply_registration_to_image</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">zarr_url</span><span class="p">,</span> <span class="n">registered_roi_table</span><span class="p">,</span> <span class="n">reference_acquisition</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">overwrite_input</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#fractal_tasks_core.tasks.apply_registration_to_image.apply_registration_to_image" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

      <p>Apply registration to images by using a registered ROI table</p>
<p>This task consists of 4 parts:</p>
<ol>
<li>Mask all regions in images that are not available in the
registered ROI table and store each acquisition aligned to the
reference_acquisition (by looping over ROIs).</li>
<li>Do the same for all label images.</li>
<li>Copy all tables from the non-aligned image to the aligned image
(currently only works well if the only tables are well &amp; FOV ROI tables
(registered and original). Not implemented for measurement tables and
other ROI tables).</li>
<li>Clean up: Delete the old, non-aligned image and rename the new,
aligned image to take over its place.</li>
</ol>


<table>
      <thead>
        <tr>
          <th><span class="doc-section-title">PARAMETER</span></th>
          <th><span>DESCRIPTION</span></th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>zarr_url</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Path or url to the individual OME-Zarr image to be processed.
(standard argument for Fractal tasks, managed by Fractal server).</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/stdtypes.html#str">str</a></code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>registered_roi_table</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Name of the ROI table which has been registered
and will be applied to mask and shift the images.
Examples: <code>registered_FOV_ROI_table</code> =&gt; loop over the field of
views, <code>registered_well_ROI_table</code> =&gt; process the whole well as
one image.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/stdtypes.html#str">str</a></code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>reference_acquisition</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Which acquisition to register against. Uses the
OME-NGFF HCS well metadata acquisition keys to find the reference
acquisition.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#int">int</a></code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>0</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>overwrite_input</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Whether the old image data should be replaced with the
newly registered image data. Currently only implemented for
<code>overwrite_input=True</code>.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#bool">bool</a></code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>True</code>
                  </span>
              </p>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>fractal_tasks_core/tasks/apply_registration_to_image.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@validate_call</span>
<span class="k">def</span> <span class="nf">apply_registration_to_image</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="c1"># Fractal parameters</span>
    <span class="n">zarr_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="c1"># Core parameters</span>
    <span class="n">registered_roi_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">reference_acquisition</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">overwrite_input</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply registration to images by using a registered ROI table</span>

<span class="sd">    This task consists of 4 parts:</span>

<span class="sd">    1. Mask all regions in images that are not available in the</span>
<span class="sd">    registered ROI table and store each acquisition aligned to the</span>
<span class="sd">    reference_acquisition (by looping over ROIs).</span>
<span class="sd">    2. Do the same for all label images.</span>
<span class="sd">    3. Copy all tables from the non-aligned image to the aligned image</span>
<span class="sd">    (currently only works well if the only tables are well &amp; FOV ROI tables</span>
<span class="sd">    (registered and original). Not implemented for measurement tables and</span>
<span class="sd">    other ROI tables).</span>
<span class="sd">    4. Clean up: Delete the old, non-aligned image and rename the new,</span>
<span class="sd">    aligned image to take over its place.</span>

<span class="sd">    Args:</span>
<span class="sd">        zarr_url: Path or url to the individual OME-Zarr image to be processed.</span>
<span class="sd">            (standard argument for Fractal tasks, managed by Fractal server).</span>
<span class="sd">        registered_roi_table: Name of the ROI table which has been registered</span>
<span class="sd">            and will be applied to mask and shift the images.</span>
<span class="sd">            Examples: `registered_FOV_ROI_table` =&gt; loop over the field of</span>
<span class="sd">            views, `registered_well_ROI_table` =&gt; process the whole well as</span>
<span class="sd">            one image.</span>
<span class="sd">        reference_acquisition: Which acquisition to register against. Uses the</span>
<span class="sd">            OME-NGFF HCS well metadata acquisition keys to find the reference</span>
<span class="sd">            acquisition.</span>
<span class="sd">        overwrite_input: Whether the old image data should be replaced with the</span>
<span class="sd">            newly registered image data. Currently only implemented for</span>
<span class="sd">            `overwrite_input=True`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">zarr_url</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Running `apply_registration_to_image` on </span><span class="si">{</span><span class="n">zarr_url</span><span class="si">=}</span><span class="s2">, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">registered_roi_table</span><span class="si">=}</span><span class="s2"> and </span><span class="si">{</span><span class="n">reference_acquisition</span><span class="si">=}</span><span class="s2">. &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="n">overwrite_input</span><span class="si">=}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="n">well_url</span><span class="p">,</span> <span class="n">old_img_path</span> <span class="o">=</span> <span class="n">_split_well_path_image_path</span><span class="p">(</span><span class="n">zarr_url</span><span class="p">)</span>
    <span class="n">new_zarr_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">well_url</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">zarr_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">_registered&quot;</span>
    <span class="c1"># Get the zarr_url for the reference acquisition</span>
    <span class="n">acq_dict</span> <span class="o">=</span> <span class="n">load_NgffWellMeta</span><span class="p">(</span><span class="n">well_url</span><span class="p">)</span><span class="o">.</span><span class="n">get_acquisition_paths</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">reference_acquisition</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">acq_dict</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">reference_acquisition</span><span class="si">=}</span><span class="s2"> was not one of the available &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;acquisitions in </span><span class="si">{</span><span class="n">acq_dict</span><span class="si">=}</span><span class="s2"> for well </span><span class="si">{</span><span class="n">well_url</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">acq_dict</span><span class="p">[</span><span class="n">reference_acquisition</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ref_path</span> <span class="o">=</span> <span class="n">_get_matching_ref_acquisition_path_heuristic</span><span class="p">(</span>
            <span class="n">acq_dict</span><span class="p">[</span><span class="n">reference_acquisition</span><span class="p">],</span> <span class="n">old_img_path</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Running registration when there are multiple images of the same &quot;</span>
            <span class="s2">&quot;acquisition in a well. Using a heuristic to match the reference &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;acquisition. Using </span><span class="si">{</span><span class="n">ref_path</span><span class="si">}</span><span class="s2"> as the reference image.&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ref_path</span> <span class="o">=</span> <span class="n">acq_dict</span><span class="p">[</span><span class="n">reference_acquisition</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">reference_zarr_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">well_url</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">ref_path</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">ROI_table_ref</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">read_zarr</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">reference_zarr_url</span><span class="si">}</span><span class="s2">/tables/</span><span class="si">{</span><span class="n">registered_roi_table</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">ROI_table_acq</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">read_zarr</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">zarr_url</span><span class="si">}</span><span class="s2">/tables/</span><span class="si">{</span><span class="n">registered_roi_table</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">ngff_image_meta</span> <span class="o">=</span> <span class="n">load_NgffImageMeta</span><span class="p">(</span><span class="n">zarr_url</span><span class="p">)</span>
    <span class="n">coarsening_xy</span> <span class="o">=</span> <span class="n">ngff_image_meta</span><span class="o">.</span><span class="n">coarsening_xy</span>
    <span class="n">num_levels</span> <span class="o">=</span> <span class="n">ngff_image_meta</span><span class="o">.</span><span class="n">num_levels</span>

    <span class="c1">####################</span>
    <span class="c1"># Process images</span>
    <span class="c1">####################</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Write the registered Zarr image to disk&quot;</span><span class="p">)</span>
    <span class="n">write_registered_zarr</span><span class="p">(</span>
        <span class="n">zarr_url</span><span class="o">=</span><span class="n">zarr_url</span><span class="p">,</span>
        <span class="n">new_zarr_url</span><span class="o">=</span><span class="n">new_zarr_url</span><span class="p">,</span>
        <span class="n">ROI_table</span><span class="o">=</span><span class="n">ROI_table_acq</span><span class="p">,</span>
        <span class="n">ROI_table_ref</span><span class="o">=</span><span class="n">ROI_table_ref</span><span class="p">,</span>
        <span class="n">num_levels</span><span class="o">=</span><span class="n">num_levels</span><span class="p">,</span>
        <span class="n">coarsening_xy</span><span class="o">=</span><span class="n">coarsening_xy</span><span class="p">,</span>
        <span class="n">aggregation_function</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1">####################</span>
    <span class="c1"># Process labels</span>
    <span class="c1">####################</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">labels_group</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open_group</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">zarr_url</span><span class="si">}</span><span class="s2">/labels&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="n">label_list</span> <span class="o">=</span> <span class="n">labels_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">zarr</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">GroupNotFoundError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
        <span class="n">label_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">label_list</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing the label images: </span><span class="si">{</span><span class="n">label_list</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">labels_group</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_zarr_url</span><span class="si">}</span><span class="s2">/labels&quot;</span><span class="p">)</span>
        <span class="n">labels_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">label_list</span>

        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">label_list</span><span class="p">:</span>
            <span class="n">write_registered_zarr</span><span class="p">(</span>
                <span class="n">zarr_url</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">zarr_url</span><span class="si">}</span><span class="s2">/labels/</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">new_zarr_url</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_zarr_url</span><span class="si">}</span><span class="s2">/labels/</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">ROI_table</span><span class="o">=</span><span class="n">ROI_table_acq</span><span class="p">,</span>
                <span class="n">ROI_table_ref</span><span class="o">=</span><span class="n">ROI_table_ref</span><span class="p">,</span>
                <span class="n">num_levels</span><span class="o">=</span><span class="n">num_levels</span><span class="p">,</span>
                <span class="n">coarsening_xy</span><span class="o">=</span><span class="n">coarsening_xy</span><span class="p">,</span>
                <span class="n">aggregation_function</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1">####################</span>
    <span class="c1"># Copy tables</span>
    <span class="c1"># 1. Copy all standard ROI tables from the reference acquisition.</span>
    <span class="c1"># 2. Copy all tables that aren&#39;t standard ROI tables from the given</span>
    <span class="c1"># acquisition.</span>
    <span class="c1">####################</span>
    <span class="n">table_dict_reference</span> <span class="o">=</span> <span class="n">_get_table_path_dict</span><span class="p">(</span><span class="n">reference_zarr_url</span><span class="p">)</span>
    <span class="n">table_dict_component</span> <span class="o">=</span> <span class="n">_get_table_path_dict</span><span class="p">(</span><span class="n">zarr_url</span><span class="p">)</span>

    <span class="n">table_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Define which table should get copied:</span>
    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">table_dict_reference</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_standard_roi_table</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
            <span class="n">table_dict</span><span class="p">[</span><span class="n">table</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_dict_reference</span><span class="p">[</span><span class="n">table</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">table_dict_component</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_standard_roi_table</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">reference_zarr_url</span> <span class="o">!=</span> <span class="n">zarr_url</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">zarr_url</span><span class="si">}</span><span class="s2"> contained a table that is not a standard &quot;</span>
                    <span class="s2">&quot;ROI table. The `Apply Registration To Image task` is &quot;</span>
                    <span class="s2">&quot;best used before additional tables are generated. It &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;will copy the </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2"> from this acquisition without &quot;</span>
                    <span class="s2">&quot;applying any transformations. This will work well if &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2"> contains measurements. But if </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2"> is a &quot;</span>
                    <span class="s2">&quot;custom ROI table coming from another task, the &quot;</span>
                    <span class="s2">&quot;transformation is not applied and it will not match &quot;</span>
                    <span class="s2">&quot;with the registered image anymore.&quot;</span>
                <span class="p">)</span>
            <span class="n">table_dict</span><span class="p">[</span><span class="n">table</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_dict_component</span><span class="p">[</span><span class="n">table</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">table_dict</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing the tables: </span><span class="si">{</span><span class="n">table_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">new_image_group</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">new_zarr_url</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">table_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Copying table: </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Get the relevant metadata of the Zarr table &amp; add it</span>
            <span class="c1"># See issue #516 for the need for this workaround</span>
            <span class="n">max_retries</span> <span class="o">=</span> <span class="mi">20</span>
            <span class="n">sleep_time</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">current_round</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">current_round</span> <span class="o">&lt;</span> <span class="n">max_retries</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">old_table_group</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open_group</span><span class="p">(</span>
                        <span class="n">table_dict</span><span class="p">[</span><span class="n">table</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span>
                    <span class="p">)</span>
                    <span class="n">current_round</span> <span class="o">=</span> <span class="n">max_retries</span>
                    <span class="n">curr_table</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">read_zarr</span><span class="p">(</span><span class="n">table_dict</span><span class="p">[</span><span class="n">table</span><span class="p">])</span>
                    <span class="k">break</span>  <span class="c1"># Exit loop on success</span>
                <span class="k">except</span> <span class="p">(</span>
                    <span class="n">zarr</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">GroupNotFoundError</span><span class="p">,</span>
                    <span class="n">zarr</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">PathNotFoundError</span><span class="p">,</span>
                    <span class="ne">FileNotFoundError</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Table </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2"> not found in attempt </span><span class="si">{</span><span class="n">current_round</span><span class="si">}</span><span class="s2">. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Waiting </span><span class="si">{</span><span class="n">sleep_time</span><span class="si">}</span><span class="s2"> seconds before trying again.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">current_round</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># This runs only if the loop exits via exhaustion</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Table </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2"> not found after </span><span class="si">{</span><span class="n">max_retries</span><span class="si">}</span><span class="s2"> attempts.&quot;</span>
                    <span class="s2">&quot;Check whether this table actually exists. If it does, &quot;</span>
                    <span class="s2">&quot;this may be a race condition issue.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Write the Zarr table</span>
            <span class="n">write_table</span><span class="p">(</span>
                <span class="n">new_image_group</span><span class="p">,</span>
                <span class="n">table</span><span class="p">,</span>
                <span class="n">curr_table</span><span class="p">,</span>
                <span class="n">table_attrs</span><span class="o">=</span><span class="n">old_table_group</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">asdict</span><span class="p">(),</span>
                <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1">####################</span>
    <span class="c1"># Clean up Zarr file</span>
    <span class="c1">####################</span>
    <span class="k">if</span> <span class="n">overwrite_input</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Replace original zarr image with the newly created Zarr image&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Potential for race conditions: Every acquisition reads the</span>
        <span class="c1"># reference acquisition, but the reference acquisition also gets</span>
        <span class="c1"># modified</span>
        <span class="c1"># See issue #516 for the details</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">zarr_url</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">zarr_url</span><span class="si">}</span><span class="s2">_tmp&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">new_zarr_url</span><span class="p">,</span> <span class="n">zarr_url</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">zarr_url</span><span class="si">}</span><span class="s2">_tmp&quot;</span><span class="p">)</span>
        <span class="n">image_list_updates</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">image_list_updates</span><span class="o">=</span><span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">zarr_url</span><span class="o">=</span><span class="n">zarr_url</span><span class="p">)])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">image_list_updates</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">image_list_updates</span><span class="o">=</span><span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">zarr_url</span><span class="o">=</span><span class="n">new_zarr_url</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">zarr_url</span><span class="p">)]</span>
        <span class="p">)</span>
        <span class="c1"># Update the metadata of the the well</span>
        <span class="n">well_url</span><span class="p">,</span> <span class="n">new_img_path</span> <span class="o">=</span> <span class="n">_split_well_path_image_path</span><span class="p">(</span><span class="n">new_zarr_url</span><span class="p">)</span>
        <span class="n">_update_well_metadata</span><span class="p">(</span>
            <span class="n">well_url</span><span class="o">=</span><span class="n">well_url</span><span class="p">,</span>
            <span class="n">old_image_path</span><span class="o">=</span><span class="n">old_img_path</span><span class="p">,</span>
            <span class="n">new_image_path</span><span class="o">=</span><span class="n">new_img_path</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">image_list_updates</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="fractal_tasks_core.tasks.apply_registration_to_image.write_registered_zarr" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">write_registered_zarr</span><span class="p">(</span><span class="n">zarr_url</span><span class="p">,</span> <span class="n">new_zarr_url</span><span class="p">,</span> <span class="n">ROI_table</span><span class="p">,</span> <span class="n">ROI_table_ref</span><span class="p">,</span> <span class="n">num_levels</span><span class="p">,</span> <span class="n">coarsening_xy</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">aggregation_function</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span></code>

<a href="#fractal_tasks_core.tasks.apply_registration_to_image.write_registered_zarr" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

      <p>Write registered zarr array based on ROI tables</p>
<p>This function loads the image or label data from a zarr array based on the
ROI bounding-box coordinates and stores them into a new zarr array.
The new Zarr array has the same shape as the original array, but will have
0s where the ROI tables don't specify loading of the image data.
The ROIs loaded from <code>list_indices</code> will be written into the
<code>list_indices_ref</code> position, thus performing translational registration if
the two lists of ROI indices vary.</p>


<table>
      <thead>
        <tr>
          <th><span class="doc-section-title">PARAMETER</span></th>
          <th><span>DESCRIPTION</span></th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>zarr_url</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Path or url to the individual OME-Zarr image to be used as
the basis for the new OME-Zarr image.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/stdtypes.html#str">str</a></code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>new_zarr_url</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Path or url to the new OME-Zarr image to be written</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/stdtypes.html#str">str</a></code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>ROI_table</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Fractal ROI table for the component</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" title="anndata.AnnData" href="https://anndata.readthedocs.io/en/latest/generated/anndata.AnnData.html#anndata.AnnData">AnnData</a></code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>ROI_table_ref</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Fractal ROI table for the reference acquisition</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" title="anndata.AnnData" href="https://anndata.readthedocs.io/en/latest/generated/anndata.AnnData.html#anndata.AnnData">AnnData</a></code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>num_levels</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Number of pyramid layers to be created (argument of
<code>build_pyramid</code>).</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#int">int</a></code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>coarsening_xy</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Coarsening factor between pyramid levels</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#int">int</a></code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>2</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>aggregation_function</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Function to be used when downsampling (argument
of <code>build_pyramid</code>).</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" title="typing.Callable" href="https://docs.python.org/library/typing.html#typing.Callable">Callable</a></code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code><a class="autorefs autorefs-external" title="numpy.mean" href="https://numpy.org/doc/stable/reference/generated/numpy.mean.html#numpy.mean">mean</a></code>
                  </span>
              </p>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>fractal_tasks_core/tasks/apply_registration_to_image.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">write_registered_zarr</span><span class="p">(</span>
    <span class="n">zarr_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">new_zarr_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">ROI_table</span><span class="p">:</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">,</span>
    <span class="n">ROI_table_ref</span><span class="p">:</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">,</span>
    <span class="n">num_levels</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">coarsening_xy</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">aggregation_function</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write registered zarr array based on ROI tables</span>

<span class="sd">    This function loads the image or label data from a zarr array based on the</span>
<span class="sd">    ROI bounding-box coordinates and stores them into a new zarr array.</span>
<span class="sd">    The new Zarr array has the same shape as the original array, but will have</span>
<span class="sd">    0s where the ROI tables don&#39;t specify loading of the image data.</span>
<span class="sd">    The ROIs loaded from `list_indices` will be written into the</span>
<span class="sd">    `list_indices_ref` position, thus performing translational registration if</span>
<span class="sd">    the two lists of ROI indices vary.</span>

<span class="sd">    Args:</span>
<span class="sd">        zarr_url: Path or url to the individual OME-Zarr image to be used as</span>
<span class="sd">            the basis for the new OME-Zarr image.</span>
<span class="sd">        new_zarr_url: Path or url to the new OME-Zarr image to be written</span>
<span class="sd">        ROI_table: Fractal ROI table for the component</span>
<span class="sd">        ROI_table_ref: Fractal ROI table for the reference acquisition</span>
<span class="sd">        num_levels: Number of pyramid layers to be created (argument of</span>
<span class="sd">            `build_pyramid`).</span>
<span class="sd">        coarsening_xy: Coarsening factor between pyramid levels</span>
<span class="sd">        aggregation_function: Function to be used when downsampling (argument</span>
<span class="sd">            of `build_pyramid`).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Read pixel sizes from Zarr attributes</span>
    <span class="n">ngff_image_meta</span> <span class="o">=</span> <span class="n">load_NgffImageMeta</span><span class="p">(</span><span class="n">zarr_url</span><span class="p">)</span>
    <span class="n">pxl_sizes_zyx</span> <span class="o">=</span> <span class="n">ngff_image_meta</span><span class="o">.</span><span class="n">get_pixel_sizes_zyx</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Create list of indices for 3D ROIs</span>
    <span class="n">list_indices</span> <span class="o">=</span> <span class="n">convert_ROI_table_to_indices</span><span class="p">(</span>
        <span class="n">ROI_table</span><span class="p">,</span>
        <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">coarsening_xy</span><span class="o">=</span><span class="n">coarsening_xy</span><span class="p">,</span>
        <span class="n">full_res_pxl_sizes_zyx</span><span class="o">=</span><span class="n">pxl_sizes_zyx</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">list_indices_ref</span> <span class="o">=</span> <span class="n">convert_ROI_table_to_indices</span><span class="p">(</span>
        <span class="n">ROI_table_ref</span><span class="p">,</span>
        <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">coarsening_xy</span><span class="o">=</span><span class="n">coarsening_xy</span><span class="p">,</span>
        <span class="n">full_res_pxl_sizes_zyx</span><span class="o">=</span><span class="n">pxl_sizes_zyx</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">old_image_group</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open_group</span><span class="p">(</span><span class="n">zarr_url</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
    <span class="n">old_ngff_image_meta</span> <span class="o">=</span> <span class="n">load_NgffImageMeta</span><span class="p">(</span><span class="n">zarr_url</span><span class="p">)</span>
    <span class="n">new_image_group</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">new_zarr_url</span><span class="p">)</span>
    <span class="n">new_image_group</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">old_image_group</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">asdict</span><span class="p">())</span>

    <span class="c1"># Loop over all channels. For each channel, write full-res image data.</span>
    <span class="n">data_array</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">from_zarr</span><span class="p">(</span><span class="n">old_image_group</span><span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">])</span>
    <span class="c1"># Create dask array with 0s of same shape</span>
    <span class="n">new_array</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data_array</span><span class="p">)</span>

    <span class="c1"># TODO: Add sanity checks on the 2 ROI tables:</span>
    <span class="c1"># 1. The number of ROIs need to match</span>
    <span class="c1"># 2. The size of the ROIs need to match</span>
    <span class="c1"># (otherwise, we can&#39;t assign them to the reference regions)</span>
    <span class="c1"># ROI_table_ref vs ROI_table_acq</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">roi_indices</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">list_indices</span><span class="p">):</span>
        <span class="n">reference_region</span> <span class="o">=</span> <span class="n">convert_indices_to_regions</span><span class="p">(</span><span class="n">list_indices_ref</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">region</span> <span class="o">=</span> <span class="n">convert_indices_to_regions</span><span class="p">(</span><span class="n">roi_indices</span><span class="p">)</span>

        <span class="n">axes_list</span> <span class="o">=</span> <span class="n">old_ngff_image_meta</span><span class="o">.</span><span class="n">axes_names</span>

        <span class="k">if</span> <span class="n">axes_list</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">]:</span>
            <span class="n">num_channels</span> <span class="o">=</span> <span class="n">data_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Loop over channels</span>
            <span class="k">for</span> <span class="n">ind_ch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_channels</span><span class="p">):</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                    <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="n">ind_ch</span><span class="p">,</span> <span class="n">ind_ch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">reference_region</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">new_array</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_region</span><span class="p">(</span>
                    <span class="n">data_zyx</span><span class="o">=</span><span class="n">data_array</span><span class="p">[</span><span class="n">ind_ch</span><span class="p">],</span> <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">axes_list</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">]:</span>
            <span class="n">new_array</span><span class="p">[</span><span class="n">reference_region</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_region</span><span class="p">(</span>
                <span class="n">data_zyx</span><span class="o">=</span><span class="n">data_array</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">axes_list</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">]:</span>
            <span class="c1"># TODO: Implement cyx case (based on looping over xy case)</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;`write_registered_zarr` has not been implemented for &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;a zarr with </span><span class="si">{</span><span class="n">axes_list</span><span class="si">=}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">axes_list</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">]:</span>
            <span class="c1"># TODO: Implement yx case</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;`write_registered_zarr` has not been implemented for &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;a zarr with </span><span class="si">{</span><span class="n">axes_list</span><span class="si">=}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;`write_registered_zarr` has not been implemented for &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;a zarr with </span><span class="si">{</span><span class="n">axes_list</span><span class="si">=}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="n">new_array</span><span class="o">.</span><span class="n">to_zarr</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_zarr_url</span><span class="si">}</span><span class="s2">/0&quot;</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">dimension_separator</span><span class="o">=</span><span class="s2">&quot;/&quot;</span><span class="p">,</span>
        <span class="n">write_empty_chunks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Starting from on-disk highest-resolution data, build and write to</span>
    <span class="c1"># disk a pyramid of coarser levels</span>
    <span class="n">build_pyramid</span><span class="p">(</span>
        <span class="n">zarrurl</span><span class="o">=</span><span class="n">new_zarr_url</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">num_levels</span><span class="o">=</span><span class="n">num_levels</span><span class="p">,</span>
        <span class="n">coarsening_xy</span><span class="o">=</span><span class="n">coarsening_xy</span><span class="p">,</span>
        <span class="n">chunksize</span><span class="o">=</span><span class="n">data_array</span><span class="o">.</span><span class="n">chunksize</span><span class="p">,</span>
        <span class="n">aggregation_function</span><span class="o">=</span><span class="n">aggregation_function</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      © Copyright 2024
University of Zurich
(see <u><a href="https://github.com/fractal-analytics-platform/fractal-tasks-core/blob/main/LICENSE">
LICENSE
</a></u>).

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["content.code.annotate", "content.code.copy"], "search": "../../../../assets/javascripts/workers/search.74e28a9f.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.220ee61c.min.js"></script>
      
        
          <script src="../../../../javascripts/mathjax.js"></script>
        
      
        
          <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
        
      
        
          <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        
      
    
  </body>
</html>