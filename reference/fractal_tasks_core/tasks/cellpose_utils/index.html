
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../cellpose_segmentation/">
      
      
        <link rel="next" href="../cellvoyager_to_ome_zarr_compute/">
      
      <link rel="icon" href="https://raw.githubusercontent.com/fractal-analytics-platform/fractal-logos/refs/heads/main/common/fractal_favicon.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-9.1.21">
    
    
      
        <title>cellpose_utils - Fractal Tasks Core</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.eebd395e.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../../extra.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="light-blue">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#fractal_tasks_core.tasks.cellpose_utils" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="Fractal Tasks Core" class="md-header__button md-logo" aria-label="Fractal Tasks Core" data-md-component="logo">
      
  <img src="https://raw.githubusercontent.com/fractal-analytics-platform/fractal-logos/refs/heads/main/common/fractal_logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Fractal Tasks Core
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              cellpose_utils
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="light-blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="light-blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
              </label>
            
          
        </form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/fractal-analytics-platform/fractal-tasks-core" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    fractal-tasks-core
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Fractal Tasks Core" class="md-nav__button md-logo" aria-label="Fractal Tasks Core" data-md-component="logo">
      
  <img src="https://raw.githubusercontent.com/fractal-analytics-platform/fractal-logos/refs/heads/main/common/fractal_logo.png" alt="logo">

    </a>
    Fractal Tasks Core
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/fractal-analytics-platform/fractal-tasks-core" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    fractal-tasks-core
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        Home page
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../install/" class="md-nav__link">
        Install
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../../run_tasks/">Run tasks</a>
          
            <label for="__nav_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Run tasks
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../run_tasks/tasks_in_fractal/" class="md-nav__link">
        Within Fractal
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../run_tasks/tasks_in_scripts/" class="md-nav__link">
        From Python scripts
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../all_tasks/" class="md-nav__link">
        Task list
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../tables/" class="md-nav__link">
        Table specs
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../custom_task/" class="md-nav__link">
        Write custom tasks
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../development/" class="md-nav__link">
        Development
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked>
      
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          Code reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Code reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1" checked>
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../">tasks</a>
          
            <label for="__nav_8_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_1_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_8_1">
          <span class="md-nav__icon md-icon"></span>
          tasks
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../_registration_utils/" class="md-nav__link">
        _registration_utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../_utils/" class="md-nav__link">
        _utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../_zarr_utils/" class="md-nav__link">
        _zarr_utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../apply_registration_to_image/" class="md-nav__link">
        apply_registration_to_image
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../calculate_registration_image_based/" class="md-nav__link">
        calculate_registration_image_based
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cellpose_segmentation/" class="md-nav__link">
        cellpose_segmentation
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          cellpose_utils
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        cellpose_utils
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.cellpose_utils" class="md-nav__link">
    cellpose_utils
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.cellpose_utils.CellposeChannel1InputModel" class="md-nav__link">
    CellposeChannel1InputModel
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.cellpose_utils.CellposeChannel2InputModel" class="md-nav__link">
    CellposeChannel2InputModel
  </a>
  
    <nav class="md-nav" aria-label="CellposeChannel2InputModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.cellpose_utils.CellposeChannel2InputModel.mutually_exclusive_channel_attributes" class="md-nav__link">
    mutually_exclusive_channel_attributes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.cellpose_utils.CellposeCustomNormalizer" class="md-nav__link">
    CellposeCustomNormalizer
  </a>
  
    <nav class="md-nav" aria-label="CellposeCustomNormalizer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.cellpose_utils.CellposeCustomNormalizer.cellpose_normalize" class="md-nav__link">
    cellpose_normalize
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.cellpose_utils.CellposeModelParams" class="md-nav__link">
    CellposeModelParams
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.cellpose_utils._normalize_cellpose_channels" class="md-nav__link">
    _normalize_cellpose_channels
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.cellpose_utils.normalize_bounds" class="md-nav__link">
    normalize_bounds
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.cellpose_utils.normalize_percentile" class="md-nav__link">
    normalize_percentile
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.cellpose_utils.normalized_img" class="md-nav__link">
    normalized_img
  </a>
  
    <nav class="md-nav" aria-label="normalized_img">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.cellpose_utils.normalized_img--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.cellpose_utils.normalized_img--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cellvoyager_to_ome_zarr_compute/" class="md-nav__link">
        cellvoyager_to_ome_zarr_compute
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cellvoyager_to_ome_zarr_init/" class="md-nav__link">
        cellvoyager_to_ome_zarr_init
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cellvoyager_to_ome_zarr_init_multiplex/" class="md-nav__link">
        cellvoyager_to_ome_zarr_init_multiplex
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../copy_ome_zarr_hcs_plate/" class="md-nav__link">
        copy_ome_zarr_hcs_plate
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../find_registration_consensus/" class="md-nav__link">
        find_registration_consensus
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../illumination_correction/" class="md-nav__link">
        illumination_correction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../image_based_registration_hcs_init/" class="md-nav__link">
        image_based_registration_hcs_init
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../import_ome_zarr/" class="md-nav__link">
        import_ome_zarr
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../init_group_by_well_for_multiplexing/" class="md-nav__link">
        init_group_by_well_for_multiplexing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../io_models/" class="md-nav__link">
        io_models
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../napari_workflows_wrapper/" class="md-nav__link">
        napari_workflows_wrapper
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../projection/" class="md-nav__link">
        projection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../projection_utils/" class="md-nav__link">
        projection_utils
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_2" >
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../dev/">dev</a>
          
            <label for="__nav_8_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_2">
          <span class="md-nav__icon md-icon"></span>
          dev
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/create_manifest/" class="md-nav__link">
        create_manifest
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/deprecation_message/" class="md-nav__link">
        deprecation_message
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/lib_args_schemas/" class="md-nav__link">
        lib_args_schemas
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/lib_descriptions/" class="md-nav__link">
        lib_descriptions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/lib_pydantic_generatejsonschema/" class="md-nav__link">
        lib_pydantic_generatejsonschema
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/lib_signature_constraints/" class="md-nav__link">
        lib_signature_constraints
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/lib_task_docs/" class="md-nav__link">
        lib_task_docs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/lib_titles/" class="md-nav__link">
        lib_titles
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/task_list/" class="md-nav__link">
        task_list
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dev/task_models/" class="md-nav__link">
        task_models
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_3" >
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../cellvoyager/">cellvoyager</a>
          
            <label for="__nav_8_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_3">
          <span class="md-nav__icon md-icon"></span>
          cellvoyager
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cellvoyager/filenames/" class="md-nav__link">
        filenames
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cellvoyager/metadata/" class="md-nav__link">
        metadata
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cellvoyager/wells/" class="md-nav__link">
        wells
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../channels/" class="md-nav__link">
        channels
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../labels/" class="md-nav__link">
        labels
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../masked_loading/" class="md-nav__link">
        masked_loading
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_7" >
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../ngff/">ngff</a>
          
            <label for="__nav_8_7">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_7">
          <span class="md-nav__icon md-icon"></span>
          ngff
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ngff/specs/" class="md-nav__link">
        specs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ngff/zarr_utils/" class="md-nav__link">
        zarr_utils
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pyramids/" class="md-nav__link">
        pyramids
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_9" >
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../roi/">roi</a>
          
            <label for="__nav_8_9">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_9">
          <span class="md-nav__icon md-icon"></span>
          roi
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../roi/_overlaps_common/" class="md-nav__link">
        _overlaps_common
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../roi/load_region/" class="md-nav__link">
        load_region
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../roi/v1/" class="md-nav__link">
        v1
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../roi/v1_checks/" class="md-nav__link">
        v1_checks
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../roi/v1_overlaps/" class="md-nav__link">
        v1_overlaps
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_10" >
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../tables/">tables</a>
          
            <label for="__nav_8_10">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_10_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_10">
          <span class="md-nav__icon md-icon"></span>
          tables
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tables/v1/" class="md-nav__link">
        v1
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../upscale_array/" class="md-nav__link">
        upscale_array
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/" class="md-nav__link">
        utils
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../zarr_utils/" class="md-nav__link">
        zarr_utils
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../changelog/" class="md-nav__link">
        Changelog
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.cellpose_utils" class="md-nav__link">
    cellpose_utils
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.cellpose_utils.CellposeChannel1InputModel" class="md-nav__link">
    CellposeChannel1InputModel
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.cellpose_utils.CellposeChannel2InputModel" class="md-nav__link">
    CellposeChannel2InputModel
  </a>
  
    <nav class="md-nav" aria-label="CellposeChannel2InputModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.cellpose_utils.CellposeChannel2InputModel.mutually_exclusive_channel_attributes" class="md-nav__link">
    mutually_exclusive_channel_attributes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.cellpose_utils.CellposeCustomNormalizer" class="md-nav__link">
    CellposeCustomNormalizer
  </a>
  
    <nav class="md-nav" aria-label="CellposeCustomNormalizer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.cellpose_utils.CellposeCustomNormalizer.cellpose_normalize" class="md-nav__link">
    cellpose_normalize
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.cellpose_utils.CellposeModelParams" class="md-nav__link">
    CellposeModelParams
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.cellpose_utils._normalize_cellpose_channels" class="md-nav__link">
    _normalize_cellpose_channels
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.cellpose_utils.normalize_bounds" class="md-nav__link">
    normalize_bounds
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.cellpose_utils.normalize_percentile" class="md-nav__link">
    normalize_percentile
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.cellpose_utils.normalized_img" class="md-nav__link">
    normalized_img
  </a>
  
    <nav class="md-nav" aria-label="normalized_img">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.cellpose_utils.normalized_img--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fractal_tasks_core.tasks.cellpose_utils.normalized_img--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>cellpose_utils</h1>

<div class="doc doc-object doc-module">



<a id="fractal_tasks_core.tasks.cellpose_utils"></a>
    <div class="doc doc-contents first">

      <p>Helper functions for image normalization in</p>



  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="fractal_tasks_core.tasks.cellpose_utils.CellposeChannel1InputModel" class="doc doc-heading">
            <code>CellposeChannel1InputModel</code>


<a href="#fractal_tasks_core.tasks.cellpose_utils.CellposeChannel1InputModel" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="fractal_tasks_core.channels.ChannelInputModel" href="../../channels/#fractal_tasks_core.channels.ChannelInputModel">ChannelInputModel</a></code></p>


      <p>Channel input for cellpose with normalization options.</p>


<table>
      <thead>
        <tr>
          <th><span class="doc-section-title">ATTRIBUTE</span></th>
          <th><span>DESCRIPTION</span></th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="fractal_tasks_core.tasks.cellpose_utils.CellposeChannel1InputModel.wavelength_id">wavelength_id</span></code></td>
            <td class="doc-attribute-details">
              <div class="doc-md-description">
                <p>Unique ID for the channel wavelength, e.g. <code>A01_C01</code>.
Can only be specified if label is not set.</p>
              </div>
              <p>
                  <span class="doc-attribute-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/library/stdtypes.html#str">str</a>]</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fractal_tasks_core.tasks.cellpose_utils.CellposeChannel1InputModel.label">label</span></code></td>
            <td class="doc-attribute-details">
              <div class="doc-md-description">
                <p>Name of the channel. Can only be specified if wavelength_id is
not set.</p>
              </div>
              <p>
                  <span class="doc-attribute-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/library/stdtypes.html#str">str</a>]</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fractal_tasks_core.tasks.cellpose_utils.CellposeChannel1InputModel.normalize">normalize</span></code></td>
            <td class="doc-attribute-details">
              <div class="doc-md-description">
                <p>Validator to handle different normalization scenarios for
Cellpose models</p>
              </div>
              <p>
                  <span class="doc-attribute-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-internal" title="fractal_tasks_core.tasks.cellpose_utils.CellposeCustomNormalizer" href="#fractal_tasks_core.tasks.cellpose_utils.CellposeCustomNormalizer">CellposeCustomNormalizer</a></code>
                  </span>
              </p>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>fractal_tasks_core/tasks/cellpose_utils.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">CellposeChannel1InputModel</span><span class="p">(</span><span class="n">ChannelInputModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Channel input for cellpose with normalization options.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        wavelength_id: Unique ID for the channel wavelength, e.g. `A01_C01`.</span>
<span class="sd">            Can only be specified if label is not set.</span>
<span class="sd">        label: Name of the channel. Can only be specified if wavelength_id is</span>
<span class="sd">            not set.</span>
<span class="sd">        normalize: Validator to handle different normalization scenarios for</span>
<span class="sd">            Cellpose models</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">normalize</span><span class="p">:</span> <span class="n">CellposeCustomNormalizer</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">CellposeCustomNormalizer</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_omero_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zarr_url</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OmeroChannel</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">get_channel_from_image_zarr</span><span class="p">(</span>
                <span class="n">image_zarr_path</span><span class="o">=</span><span class="n">zarr_url</span><span class="p">,</span>
                <span class="n">wavelength_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wavelength_id</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">ChannelNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Channel with wavelength_id: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">wavelength_id</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;and label: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s2"> not found, exit from the task.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Original error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="fractal_tasks_core.tasks.cellpose_utils.CellposeChannel2InputModel" class="doc doc-heading">
            <code>CellposeChannel2InputModel</code>


<a href="#fractal_tasks_core.tasks.cellpose_utils.CellposeChannel2InputModel" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="pydantic.BaseModel">BaseModel</span></code></p>


      <p>Channel input for secondary cellpose channel with normalization options.</p>
<p>The secondary channel is Optional, thus both wavelength_id and label are
optional to be set. The <code>is_set</code> function shows whether either value was
set.</p>


<table>
      <thead>
        <tr>
          <th><span class="doc-section-title">ATTRIBUTE</span></th>
          <th><span>DESCRIPTION</span></th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="fractal_tasks_core.tasks.cellpose_utils.CellposeChannel2InputModel.wavelength_id">wavelength_id</span></code></td>
            <td class="doc-attribute-details">
              <div class="doc-md-description">
                <p>Unique ID for the channel wavelength, e.g. <code>A01_C01</code>.
Can only be specified if label is not set.</p>
              </div>
              <p>
                  <span class="doc-attribute-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/library/stdtypes.html#str">str</a>]</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fractal_tasks_core.tasks.cellpose_utils.CellposeChannel2InputModel.label">label</span></code></td>
            <td class="doc-attribute-details">
              <div class="doc-md-description">
                <p>Name of the channel. Can only be specified if wavelength_id is
not set.</p>
              </div>
              <p>
                  <span class="doc-attribute-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/library/stdtypes.html#str">str</a>]</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fractal_tasks_core.tasks.cellpose_utils.CellposeChannel2InputModel.normalize">normalize</span></code></td>
            <td class="doc-attribute-details">
              <div class="doc-md-description">
                <p>Validator to handle different normalization scenarios for
Cellpose models</p>
              </div>
              <p>
                  <span class="doc-attribute-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-internal" title="fractal_tasks_core.tasks.cellpose_utils.CellposeCustomNormalizer" href="#fractal_tasks_core.tasks.cellpose_utils.CellposeCustomNormalizer">CellposeCustomNormalizer</a></code>
                  </span>
              </p>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>fractal_tasks_core/tasks/cellpose_utils.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">CellposeChannel2InputModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Channel input for secondary cellpose channel with normalization options.</span>

<span class="sd">    The secondary channel is Optional, thus both wavelength_id and label are</span>
<span class="sd">    optional to be set. The `is_set` function shows whether either value was</span>
<span class="sd">    set.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        wavelength_id: Unique ID for the channel wavelength, e.g. `A01_C01`.</span>
<span class="sd">            Can only be specified if label is not set.</span>
<span class="sd">        label: Name of the channel. Can only be specified if wavelength_id is</span>
<span class="sd">            not set.</span>
<span class="sd">        normalize: Validator to handle different normalization scenarios for</span>
<span class="sd">            Cellpose models</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">wavelength_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">normalize</span><span class="p">:</span> <span class="n">CellposeCustomNormalizer</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">CellposeCustomNormalizer</span>
    <span class="p">)</span>

    <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">mutually_exclusive_channel_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that only 1 of `label` or `wavelength_id` is set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wavelength_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavelength_id</span>
        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">wavelength_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;`wavelength_id` and `label` cannot be both set &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(given </span><span class="si">{</span><span class="n">wavelength_id</span><span class="si">=}</span><span class="s2"> and </span><span class="si">{</span><span class="n">label</span><span class="si">=}</span><span class="s2">).&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">is_set</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavelength_id</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">get_omero_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zarr_url</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OmeroChannel</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">get_channel_from_image_zarr</span><span class="p">(</span>
                <span class="n">image_zarr_path</span><span class="o">=</span><span class="n">zarr_url</span><span class="p">,</span>
                <span class="n">wavelength_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wavelength_id</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">ChannelNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Second channel with wavelength_id: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">wavelength_id</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;and label: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s2"> not found, exit from the task.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Original error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="fractal_tasks_core.tasks.cellpose_utils.CellposeChannel2InputModel.mutually_exclusive_channel_attributes" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">mutually_exclusive_channel_attributes</span><span class="p">()</span></code>

<a href="#fractal_tasks_core.tasks.cellpose_utils.CellposeChannel2InputModel.mutually_exclusive_channel_attributes" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

      <p>Check that only 1 of <code>label</code> or <code>wavelength_id</code> is set.</p>

            <details class="quote">
              <summary>Source code in <code>fractal_tasks_core/tasks/cellpose_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mutually_exclusive_channel_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check that only 1 of `label` or `wavelength_id` is set.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wavelength_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavelength_id</span>
    <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">wavelength_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;`wavelength_id` and `label` cannot be both set &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;(given </span><span class="si">{</span><span class="n">wavelength_id</span><span class="si">=}</span><span class="s2"> and </span><span class="si">{</span><span class="n">label</span><span class="si">=}</span><span class="s2">).&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="fractal_tasks_core.tasks.cellpose_utils.CellposeCustomNormalizer" class="doc doc-heading">
            <code>CellposeCustomNormalizer</code>


<a href="#fractal_tasks_core.tasks.cellpose_utils.CellposeCustomNormalizer" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="pydantic.BaseModel">BaseModel</span></code></p>


      <p>Validator to handle different normalization scenarios for Cellpose models</p>
<p>If <code>type="default"</code>, then Cellpose default normalization is
used and no other parameters can be specified.
If <code>type="no_normalization"</code>, then no normalization is used and no
other parameters can be specified.
If <code>type="custom"</code>, then either percentiles or explicit integer
bounds can be applied.</p>


<table>
      <thead>
        <tr>
          <th><span class="doc-section-title">ATTRIBUTE</span></th>
          <th><span>DESCRIPTION</span></th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="fractal_tasks_core.tasks.cellpose_utils.CellposeCustomNormalizer.type">type</span></code></td>
            <td class="doc-attribute-details">
              <div class="doc-md-description">
                <p>One of <code>default</code> (Cellpose default normalization), <code>custom</code>
(using the other custom parameters) or <code>no_normalization</code>.</p>
              </div>
              <p>
                  <span class="doc-attribute-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" title="typing.Literal" href="https://docs.python.org/library/typing.html#typing.Literal">Literal</a>[&#39;default&#39;, &#39;custom&#39;, &#39;no_normalization&#39;]</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fractal_tasks_core.tasks.cellpose_utils.CellposeCustomNormalizer.lower_percentile">lower_percentile</span></code></td>
            <td class="doc-attribute-details">
              <div class="doc-md-description">
                <p>Specify a custom lower-bound percentile for rescaling
as a float value between 0 and 100. Set to 1 to run the same as
default). You can only specify percentiles or bounds, not both.</p>
              </div>
              <p>
                  <span class="doc-attribute-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#float">float</a>]</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fractal_tasks_core.tasks.cellpose_utils.CellposeCustomNormalizer.upper_percentile">upper_percentile</span></code></td>
            <td class="doc-attribute-details">
              <div class="doc-md-description">
                <p>Specify a custom upper-bound percentile for rescaling
as a float value between 0 and 100. Set to 99 to run the same as
default, set to e.g. 99.99 if the default rescaling was too harsh.
You can only specify percentiles or bounds, not both.</p>
              </div>
              <p>
                  <span class="doc-attribute-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#float">float</a>]</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fractal_tasks_core.tasks.cellpose_utils.CellposeCustomNormalizer.lower_bound">lower_bound</span></code></td>
            <td class="doc-attribute-details">
              <div class="doc-md-description">
                <p>Explicit lower bound value to rescale the image at.
Needs to be an integer, e.g. 100.
You can only specify percentiles or bounds, not both.</p>
              </div>
              <p>
                  <span class="doc-attribute-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#int">int</a>]</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fractal_tasks_core.tasks.cellpose_utils.CellposeCustomNormalizer.upper_bound">upper_bound</span></code></td>
            <td class="doc-attribute-details">
              <div class="doc-md-description">
                <p>Explicit upper bound value to rescale the image at.
Needs to be an integer, e.g. 2000.
You can only specify percentiles or bounds, not both.</p>
              </div>
              <p>
                  <span class="doc-attribute-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#int">int</a>]</code>
                  </span>
              </p>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>fractal_tasks_core/tasks/cellpose_utils.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">CellposeCustomNormalizer</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validator to handle different normalization scenarios for Cellpose models</span>

<span class="sd">    If `type=&quot;default&quot;`, then Cellpose default normalization is</span>
<span class="sd">    used and no other parameters can be specified.</span>
<span class="sd">    If `type=&quot;no_normalization&quot;`, then no normalization is used and no</span>
<span class="sd">    other parameters can be specified.</span>
<span class="sd">    If `type=&quot;custom&quot;`, then either percentiles or explicit integer</span>
<span class="sd">    bounds can be applied.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        type:</span>
<span class="sd">            One of `default` (Cellpose default normalization), `custom`</span>
<span class="sd">            (using the other custom parameters) or `no_normalization`.</span>
<span class="sd">        lower_percentile: Specify a custom lower-bound percentile for rescaling</span>
<span class="sd">            as a float value between 0 and 100. Set to 1 to run the same as</span>
<span class="sd">            default). You can only specify percentiles or bounds, not both.</span>
<span class="sd">        upper_percentile: Specify a custom upper-bound percentile for rescaling</span>
<span class="sd">            as a float value between 0 and 100. Set to 99 to run the same as</span>
<span class="sd">            default, set to e.g. 99.99 if the default rescaling was too harsh.</span>
<span class="sd">            You can only specify percentiles or bounds, not both.</span>
<span class="sd">        lower_bound: Explicit lower bound value to rescale the image at.</span>
<span class="sd">            Needs to be an integer, e.g. 100.</span>
<span class="sd">            You can only specify percentiles or bounds, not both.</span>
<span class="sd">        upper_bound: Explicit upper bound value to rescale the image at.</span>
<span class="sd">            Needs to be an integer, e.g. 2000.</span>
<span class="sd">            You can only specify percentiles or bounds, not both.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="s2">&quot;custom&quot;</span><span class="p">,</span> <span class="s2">&quot;no_normalization&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
    <span class="n">lower_percentile</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">upper_percentile</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">lower_bound</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">upper_bound</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># In the future, add an option to allow using precomputed percentiles</span>
    <span class="c1"># that are stored in OME-Zarr histograms and use this pydantic model that</span>
    <span class="c1"># those histograms actually exist</span>

    <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">validate_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
        <span class="c1"># Extract values</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span>
        <span class="n">lower_percentile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_percentile</span>
        <span class="n">upper_percentile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_percentile</span>
        <span class="n">lower_bound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_bound</span>
        <span class="n">upper_bound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_bound</span>

        <span class="c1"># Verify that custom parameters are only provided when type=&quot;custom&quot;</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">!=</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lower_percentile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Type=&#39;</span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s2">&#39; but </span><span class="si">{</span><span class="n">lower_percentile</span><span class="si">=}</span><span class="s2">. &quot;</span>
                    <span class="s2">&quot;Hint: set type=&#39;custom&#39;.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">upper_percentile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Type=&#39;</span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s2">&#39; but </span><span class="si">{</span><span class="n">upper_percentile</span><span class="si">=}</span><span class="s2">. &quot;</span>
                    <span class="s2">&quot;Hint: set type=&#39;custom&#39;.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">lower_bound</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Type=&#39;</span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s2">&#39; but </span><span class="si">{</span><span class="n">lower_bound</span><span class="si">=}</span><span class="s2">. &quot;</span>
                    <span class="s2">&quot;Hint: set type=&#39;custom&#39;.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">upper_bound</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Type=&#39;</span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s2">&#39; but </span><span class="si">{</span><span class="n">upper_bound</span><span class="si">=}</span><span class="s2">. &quot;</span>
                    <span class="s2">&quot;Hint: set type=&#39;custom&#39;.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># The only valid options are:</span>
        <span class="c1"># 1. Both percentiles are set and both bounds are unset</span>
        <span class="c1"># 2. Both bounds are set and both percentiles are unset</span>
        <span class="n">are_percentiles_set</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">lower_percentile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">upper_percentile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">are_bounds_set</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">lower_bound</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">upper_bound</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">are_percentiles_set</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Both lower_percentile and upper_percentile must be set &quot;</span>
                <span class="s2">&quot;together.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">are_bounds_set</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Both lower_bound and upper_bound must be set together&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">lower_percentile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lower_bound</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;You cannot set both explicit bounds and percentile bounds &quot;</span>
                <span class="s2">&quot;at the same time. Hint: use only one of the two options.&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cellpose_normalize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine whether cellpose should apply its internal normalization.</span>

<span class="sd">        If type is set to `custom` or `no_normalization`, don&#39;t apply cellpose</span>
<span class="sd">        internal normalization</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;default&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="fractal_tasks_core.tasks.cellpose_utils.CellposeCustomNormalizer.cellpose_normalize" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cellpose_normalize</span><span class="p">:</span> <span class="nb">bool</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#fractal_tasks_core.tasks.cellpose_utils.CellposeCustomNormalizer.cellpose_normalize" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

      <p>Determine whether cellpose should apply its internal normalization.</p>
<p>If type is set to <code>custom</code> or <code>no_normalization</code>, don't apply cellpose
internal normalization</p>
    </div>

</div>





  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="fractal_tasks_core.tasks.cellpose_utils.CellposeModelParams" class="doc doc-heading">
            <code>CellposeModelParams</code>


<a href="#fractal_tasks_core.tasks.cellpose_utils.CellposeModelParams" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="pydantic.BaseModel">BaseModel</span></code></p>


      <p>Advanced Cellpose Model Parameters</p>


<table>
      <thead>
        <tr>
          <th><span class="doc-section-title">ATTRIBUTE</span></th>
          <th><span>DESCRIPTION</span></th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="fractal_tasks_core.tasks.cellpose_utils.CellposeModelParams.cellprob_threshold">cellprob_threshold</span></code></td>
            <td class="doc-attribute-details">
              <div class="doc-md-description">
                <p>Parameter of <code>CellposeModel.eval</code> method. Valid
values between -6 to 6. From Cellpose documentation: "Decrease this
threshold if cellpose is not returning as many ROIs as you'd
expect. Similarly, increase this threshold if cellpose is returning
too ROIs particularly from dim areas."</p>
              </div>
              <p>
                  <span class="doc-attribute-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#float">float</a></code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fractal_tasks_core.tasks.cellpose_utils.CellposeModelParams.flow_threshold">flow_threshold</span></code></td>
            <td class="doc-attribute-details">
              <div class="doc-md-description">
                <p>Parameter of <code>CellposeModel.eval</code> method. Valid
values between 0.0 and 1.0. From Cellpose documentation: "Increase
this threshold if cellpose is not returning as many ROIs as you'd
expect. Similarly, decrease this threshold if cellpose is returning
too many ill-shaped ROIs."</p>
              </div>
              <p>
                  <span class="doc-attribute-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#float">float</a></code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fractal_tasks_core.tasks.cellpose_utils.CellposeModelParams.anisotropy">anisotropy</span></code></td>
            <td class="doc-attribute-details">
              <div class="doc-md-description">
                <p>Ratio of the pixel sizes along Z and XY axis (ignored if
the image is not three-dimensional). If unset, it is inferred from
the OME-NGFF metadata.</p>
              </div>
              <p>
                  <span class="doc-attribute-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" title="typing.Optional" href="https://docs.python.org/library/typing.html#typing.Optional">Optional</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#float">float</a>]</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fractal_tasks_core.tasks.cellpose_utils.CellposeModelParams.min_size">min_size</span></code></td>
            <td class="doc-attribute-details">
              <div class="doc-md-description">
                <p>Parameter of <code>CellposeModel</code> class. Minimum size of the
segmented objects (in pixels). Use <code>-1</code> to turn off the size
filter.</p>
              </div>
              <p>
                  <span class="doc-attribute-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#int">int</a></code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fractal_tasks_core.tasks.cellpose_utils.CellposeModelParams.augment">augment</span></code></td>
            <td class="doc-attribute-details">
              <div class="doc-md-description">
                <p>Parameter of <code>CellposeModel</code> class. Whether to use cellpose
augmentation to tile images with overlap.</p>
              </div>
              <p>
                  <span class="doc-attribute-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#bool">bool</a></code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fractal_tasks_core.tasks.cellpose_utils.CellposeModelParams.net_avg">net_avg</span></code></td>
            <td class="doc-attribute-details">
              <div class="doc-md-description">
                <p>Parameter of <code>CellposeModel</code> class. Whether to use cellpose
net averaging to run the 4 built-in networks (useful for <code>nuclei</code>,
<code>cyto</code> and <code>cyto2</code>, not sure it works for the others).</p>
              </div>
              <p>
                  <span class="doc-attribute-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#bool">bool</a></code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fractal_tasks_core.tasks.cellpose_utils.CellposeModelParams.use_gpu">use_gpu</span></code></td>
            <td class="doc-attribute-details">
              <div class="doc-md-description">
                <p>If <code>False</code>, always use the CPU; if <code>True</code>, use the GPU if
possible (as defined in <code>cellpose.core.use_gpu()</code>) and fall-back
to the CPU otherwise.</p>
              </div>
              <p>
                  <span class="doc-attribute-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#bool">bool</a></code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fractal_tasks_core.tasks.cellpose_utils.CellposeModelParams.batch_size">batch_size</span></code></td>
            <td class="doc-attribute-details">
              <div class="doc-md-description">
                <p>number of 224x224 patches to run simultaneously on the GPU
(can make smaller or bigger depending on GPU memory usage)</p>
              </div>
              <p>
                  <span class="doc-attribute-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#int">int</a></code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fractal_tasks_core.tasks.cellpose_utils.CellposeModelParams.invert">invert</span></code></td>
            <td class="doc-attribute-details">
              <div class="doc-md-description">
                <p>invert image pixel intensity before running network (if True,
image is also normalized)</p>
              </div>
              <p>
                  <span class="doc-attribute-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#bool">bool</a></code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fractal_tasks_core.tasks.cellpose_utils.CellposeModelParams.tile">tile</span></code></td>
            <td class="doc-attribute-details">
              <div class="doc-md-description">
                <p>tiles image to ensure GPU/CPU memory usage limited (recommended)</p>
              </div>
              <p>
                  <span class="doc-attribute-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#bool">bool</a></code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fractal_tasks_core.tasks.cellpose_utils.CellposeModelParams.tile_overlap">tile_overlap</span></code></td>
            <td class="doc-attribute-details">
              <div class="doc-md-description">
                <p>fraction of overlap of tiles when computing flows</p>
              </div>
              <p>
                  <span class="doc-attribute-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#float">float</a></code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fractal_tasks_core.tasks.cellpose_utils.CellposeModelParams.resample">resample</span></code></td>
            <td class="doc-attribute-details">
              <div class="doc-md-description">
                <p>run dynamics at original image size (will be slower but
create more accurate boundaries)</p>
              </div>
              <p>
                  <span class="doc-attribute-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#bool">bool</a></code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fractal_tasks_core.tasks.cellpose_utils.CellposeModelParams.interp">interp</span></code></td>
            <td class="doc-attribute-details">
              <div class="doc-md-description">
                <p>interpolate during 2D dynamics (not available in 3D)
(in previous versions it was False, now it defaults to True)</p>
              </div>
              <p>
                  <span class="doc-attribute-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#bool">bool</a></code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="fractal_tasks_core.tasks.cellpose_utils.CellposeModelParams.stitch_threshold">stitch_threshold</span></code></td>
            <td class="doc-attribute-details">
              <div class="doc-md-description">
                <p>if stitch_threshold&gt;0.0 and not do_3D and equal
image sizes, masks are stitched in 3D to return volume segmentation</p>
              </div>
              <p>
                  <span class="doc-attribute-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#float">float</a></code>
                  </span>
              </p>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>fractal_tasks_core/tasks/cellpose_utils.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">CellposeModelParams</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Advanced Cellpose Model Parameters</span>

<span class="sd">    Attributes:</span>
<span class="sd">        cellprob_threshold: Parameter of `CellposeModel.eval` method. Valid</span>
<span class="sd">            values between -6 to 6. From Cellpose documentation: &quot;Decrease this</span>
<span class="sd">            threshold if cellpose is not returning as many ROIs as you&#39;d</span>
<span class="sd">            expect. Similarly, increase this threshold if cellpose is returning</span>
<span class="sd">            too ROIs particularly from dim areas.&quot;</span>
<span class="sd">        flow_threshold: Parameter of `CellposeModel.eval` method. Valid</span>
<span class="sd">            values between 0.0 and 1.0. From Cellpose documentation: &quot;Increase</span>
<span class="sd">            this threshold if cellpose is not returning as many ROIs as you&#39;d</span>
<span class="sd">            expect. Similarly, decrease this threshold if cellpose is returning</span>
<span class="sd">            too many ill-shaped ROIs.&quot;</span>
<span class="sd">        anisotropy: Ratio of the pixel sizes along Z and XY axis (ignored if</span>
<span class="sd">            the image is not three-dimensional). If unset, it is inferred from</span>
<span class="sd">            the OME-NGFF metadata.</span>
<span class="sd">        min_size: Parameter of `CellposeModel` class. Minimum size of the</span>
<span class="sd">            segmented objects (in pixels). Use `-1` to turn off the size</span>
<span class="sd">            filter.</span>
<span class="sd">        augment: Parameter of `CellposeModel` class. Whether to use cellpose</span>
<span class="sd">            augmentation to tile images with overlap.</span>
<span class="sd">        net_avg: Parameter of `CellposeModel` class. Whether to use cellpose</span>
<span class="sd">            net averaging to run the 4 built-in networks (useful for `nuclei`,</span>
<span class="sd">            `cyto` and `cyto2`, not sure it works for the others).</span>
<span class="sd">        use_gpu: If `False`, always use the CPU; if `True`, use the GPU if</span>
<span class="sd">            possible (as defined in `cellpose.core.use_gpu()`) and fall-back</span>
<span class="sd">            to the CPU otherwise.</span>
<span class="sd">        batch_size: number of 224x224 patches to run simultaneously on the GPU</span>
<span class="sd">            (can make smaller or bigger depending on GPU memory usage)</span>
<span class="sd">        invert: invert image pixel intensity before running network (if True,</span>
<span class="sd">            image is also normalized)</span>
<span class="sd">        tile: tiles image to ensure GPU/CPU memory usage limited (recommended)</span>
<span class="sd">        tile_overlap: fraction of overlap of tiles when computing flows</span>
<span class="sd">        resample: run dynamics at original image size (will be slower but</span>
<span class="sd">            create more accurate boundaries)</span>
<span class="sd">        interp: interpolate during 2D dynamics (not available in 3D)</span>
<span class="sd">            (in previous versions it was False, now it defaults to True)</span>
<span class="sd">        stitch_threshold: if stitch_threshold&gt;0.0 and not do_3D and equal</span>
<span class="sd">            image sizes, masks are stitched in 3D to return volume segmentation</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cellprob_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">flow_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.4</span>
    <span class="n">anisotropy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">min_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="n">augment</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">net_avg</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">use_gpu</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">invert</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">tile</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">tile_overlap</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">resample</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">interp</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">stitch_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="fractal_tasks_core.tasks.cellpose_utils._normalize_cellpose_channels" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_normalize_cellpose_channels</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="n">normalize2</span><span class="p">)</span></code>

<a href="#fractal_tasks_core.tasks.cellpose_utils._normalize_cellpose_channels" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

      <p>Normalize a cellpose input array by channel.</p>


<table>
      <thead>
        <tr>
          <th><span class="doc-section-title">PARAMETER</span></th>
          <th><span>DESCRIPTION</span></th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>x</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>4D numpy array.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" title="numpy.ndarray" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray">ndarray</a></code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>channels</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Which channels to use. If only one channel is provided, <code>[0,
0]</code> should be used. If two channels are provided (the first
dimension of <code>x</code> has length of 2), <code>[1, 2]</code> should be used
(<code>x[0, :, :,:]</code> contains the membrane channel and
<code>x[1, :, :, :]</code> contains the nuclear channel).</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/stdtypes.html#list">list</a>[<a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#int">int</a>]</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>normalize</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>By default, data is normalized so 0.0=1st percentile and
1.0=99th percentile of image intensities in each channel.
This automatic normalization can lead to issues when the image to
be segmented is very sparse. You can turn off the default
rescaling. With the "custom" option, you can either provide your
own rescaling percentiles or fixed rescaling upper and lower
bound integers.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-internal" title="fractal_tasks_core.tasks.cellpose_utils.CellposeCustomNormalizer" href="#fractal_tasks_core.tasks.cellpose_utils.CellposeCustomNormalizer">CellposeCustomNormalizer</a></code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>normalize2</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Normalization options for channel 2. If one channel is
normalized with default settings, both channels need to be
normalized with default settings.</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-internal" title="fractal_tasks_core.tasks.cellpose_utils.CellposeCustomNormalizer" href="#fractal_tasks_core.tasks.cellpose_utils.CellposeCustomNormalizer">CellposeCustomNormalizer</a></code>
                  </span>
              </p>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>fractal_tasks_core/tasks/cellpose_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">_normalize_cellpose_channels</span><span class="p">(</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">channels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
    <span class="n">normalize</span><span class="p">:</span> <span class="n">CellposeCustomNormalizer</span><span class="p">,</span>
    <span class="n">normalize2</span><span class="p">:</span> <span class="n">CellposeCustomNormalizer</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalize a cellpose input array by channel.</span>

<span class="sd">    Args:</span>
<span class="sd">        x: 4D numpy array.</span>
<span class="sd">        channels: Which channels to use. If only one channel is provided, `[0,</span>
<span class="sd">            0]` should be used. If two channels are provided (the first</span>
<span class="sd">            dimension of `x` has length of 2), `[1, 2]` should be used</span>
<span class="sd">            (`x[0, :, :,:]` contains the membrane channel and</span>
<span class="sd">            `x[1, :, :, :]` contains the nuclear channel).</span>
<span class="sd">        normalize: By default, data is normalized so 0.0=1st percentile and</span>
<span class="sd">            1.0=99th percentile of image intensities in each channel.</span>
<span class="sd">            This automatic normalization can lead to issues when the image to</span>
<span class="sd">            be segmented is very sparse. You can turn off the default</span>
<span class="sd">            rescaling. With the &quot;custom&quot; option, you can either provide your</span>
<span class="sd">            own rescaling percentiles or fixed rescaling upper and lower</span>
<span class="sd">            bound integers.</span>
<span class="sd">        normalize2: Normalization options for channel 2. If one channel is</span>
<span class="sd">            normalized with default settings, both channels need to be</span>
<span class="sd">            normalized with default settings.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Optionally perform custom normalization</span>
    <span class="c1"># normalize channels separately, if normalize2 is provided:</span>
    <span class="k">if</span> <span class="n">channels</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
        <span class="c1"># If run in single channel mode, fails (specified as channel = [0, 0])</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">normalize</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;default&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">normalize2</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;default&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;ERROR in normalization:&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">normalize</span><span class="o">.</span><span class="n">type</span><span class="si">=}</span><span class="s2"> and </span><span class="si">{</span><span class="n">normalize2</span><span class="o">.</span><span class="n">type</span><span class="si">=}</span><span class="s2">.&quot;</span>
                <span class="s2">&quot; Either both need to be &#39;default&#39;, or none of them.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">normalize</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span>
            <span class="n">x</span><span class="p">[</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">normalized_img</span><span class="p">(</span>
                <span class="n">x</span><span class="p">[</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                <span class="n">lower_p</span><span class="o">=</span><span class="n">normalize</span><span class="o">.</span><span class="n">lower_percentile</span><span class="p">,</span>
                <span class="n">upper_p</span><span class="o">=</span><span class="n">normalize</span><span class="o">.</span><span class="n">upper_percentile</span><span class="p">,</span>
                <span class="n">lower_bound</span><span class="o">=</span><span class="n">normalize</span><span class="o">.</span><span class="n">lower_bound</span><span class="p">,</span>
                <span class="n">upper_bound</span><span class="o">=</span><span class="n">normalize</span><span class="o">.</span><span class="n">upper_bound</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">normalize2</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span>
            <span class="n">x</span><span class="p">[</span><span class="n">channels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">channels</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">normalized_img</span><span class="p">(</span>
                <span class="n">x</span><span class="p">[</span><span class="n">channels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">channels</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                <span class="n">lower_p</span><span class="o">=</span><span class="n">normalize2</span><span class="o">.</span><span class="n">lower_percentile</span><span class="p">,</span>
                <span class="n">upper_p</span><span class="o">=</span><span class="n">normalize2</span><span class="o">.</span><span class="n">upper_percentile</span><span class="p">,</span>
                <span class="n">lower_bound</span><span class="o">=</span><span class="n">normalize2</span><span class="o">.</span><span class="n">lower_bound</span><span class="p">,</span>
                <span class="n">upper_bound</span><span class="o">=</span><span class="n">normalize2</span><span class="o">.</span><span class="n">upper_bound</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># otherwise, use first normalize to normalize all channels:</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">normalize</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">normalized_img</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span>
                <span class="n">lower_p</span><span class="o">=</span><span class="n">normalize</span><span class="o">.</span><span class="n">lower_percentile</span><span class="p">,</span>
                <span class="n">upper_p</span><span class="o">=</span><span class="n">normalize</span><span class="o">.</span><span class="n">upper_percentile</span><span class="p">,</span>
                <span class="n">lower_bound</span><span class="o">=</span><span class="n">normalize</span><span class="o">.</span><span class="n">lower_bound</span><span class="p">,</span>
                <span class="n">upper_bound</span><span class="o">=</span><span class="n">normalize</span><span class="o">.</span><span class="n">upper_bound</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="fractal_tasks_core.tasks.cellpose_utils.normalize_bounds" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">normalize_bounds</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">65535</span><span class="p">)</span></code>

<a href="#fractal_tasks_core.tasks.cellpose_utils.normalize_bounds" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

      <p>normalize image so 0.0 is lower value and 1.0 is upper value</p>


<table>
      <thead>
        <tr>
          <th><span class="doc-section-title">PARAMETER</span></th>
          <th><span>DESCRIPTION</span></th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>Y</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>The image to be normalized</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" title="numpy.ndarray" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray">ndarray</a></code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>lower</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Lower normalization value</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#int">int</a></code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>0</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>upper</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Upper normalization value</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#int">int</a></code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>65535</code>
                  </span>
              </p>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>fractal_tasks_core/tasks/cellpose_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">normalize_bounds</span><span class="p">(</span><span class="n">Y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">lower</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">upper</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;normalize image so 0.0 is lower value and 1.0 is upper value</span>

<span class="sd">    Args:</span>
<span class="sd">        Y: The image to be normalized</span>
<span class="sd">        lower: Lower normalization value</span>
<span class="sd">        upper: Upper normalization value</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">X</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">lower</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">upper</span> <span class="o">-</span> <span class="n">lower</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">X</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="fractal_tasks_core.tasks.cellpose_utils.normalize_percentile" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">normalize_percentile</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">99</span><span class="p">)</span></code>

<a href="#fractal_tasks_core.tasks.cellpose_utils.normalize_percentile" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

      <p>normalize image so 0.0 is lower percentile and 1.0 is upper percentile
Percentiles are passed as floats (must be between 0 and 100)</p>


<table>
      <thead>
        <tr>
          <th><span class="doc-section-title">PARAMETER</span></th>
          <th><span>DESCRIPTION</span></th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>Y</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>The image to be normalized</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" title="numpy.ndarray" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray">ndarray</a></code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>lower</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Lower percentile</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#float">float</a></code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>1</code>
                  </span>
              </p>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>upper</code></td>
            <td class="doc-param-details">
              <div class="doc-md-description">
                <p>Upper percentile</p>
              </div>
              <p>
                  <span class="doc-param-annotation">
                    <b>TYPE:</b>
                      <code><a class="autorefs autorefs-external" href="https://docs.python.org/library/functions.html#float">float</a></code>
                  </span>
                  <span class="doc-param-default">
                    <b>DEFAULT:</b>
                      <code>99</code>
                  </span>
              </p>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>fractal_tasks_core/tasks/cellpose_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">normalize_percentile</span><span class="p">(</span><span class="n">Y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">lower</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">upper</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">99</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;normalize image so 0.0 is lower percentile and 1.0 is upper percentile</span>
<span class="sd">    Percentiles are passed as floats (must be between 0 and 100)</span>

<span class="sd">    Args:</span>
<span class="sd">        Y: The image to be normalized</span>
<span class="sd">        lower: Lower percentile</span>
<span class="sd">        upper: Upper percentile</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">x01</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">lower</span><span class="p">)</span>
    <span class="n">x99</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">x01</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x99</span> <span class="o">-</span> <span class="n">x01</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">X</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="fractal_tasks_core.tasks.cellpose_utils.normalized_img" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">normalized_img</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lower_p</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">upper_p</span><span class="o">=</span><span class="mf">99.0</span><span class="p">,</span> <span class="n">lower_bound</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">upper_bound</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#fractal_tasks_core.tasks.cellpose_utils.normalized_img" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

      <p>normalize each channel of the image so that so that 0.0=lower percentile
or lower bound and 1.0=upper percentile or upper bound of image intensities.</p>
<p>The normalization can result in values &lt; 0 or &gt; 1 (no clipping).</p>
<p>Based on <a href="https://github.com/MouseLand/cellpose/blob/4f5661983c3787efa443bbbd3f60256f4fd8bf53/cellpose/transforms.py#L375">https://github.com/MouseLand/cellpose/blob/4f5661983c3787efa443bbbd3f60256f4fd8bf53/cellpose/transforms.py#L375</a> # noqa E501</p>
<p>optional inversion</p>
<h4 id="fractal_tasks_core.tasks.cellpose_utils.normalized_img--parameters">Parameters<a class="headerlink" href="#fractal_tasks_core.tasks.cellpose_utils.normalized_img--parameters" title="Permanent link">&para;</a></h4>
<p>img: ND-array (at least 3 dimensions)</p>
<p>axis: channel axis to loop over for normalization</p>
<p>invert: invert image (useful if cells are dark instead of bright)</p>
<p>lower_p: Lower percentile for rescaling</p>
<p>upper_p: Upper percentile for rescaling</p>
<p>lower_bound: Lower fixed-value used for rescaling</p>
<p>upper_bound: Upper fixed-value used for rescaling</p>
<h4 id="fractal_tasks_core.tasks.cellpose_utils.normalized_img--returns">Returns<a class="headerlink" href="#fractal_tasks_core.tasks.cellpose_utils.normalized_img--returns" title="Permanent link">&para;</a></h4>


<details class="img" open>
  <summary>ND-array, float32</summary>
  <p>normalized image of same size</p>
</details>
            <details class="quote">
              <summary>Source code in <code>fractal_tasks_core/tasks/cellpose_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">normalized_img</span><span class="p">(</span>
    <span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">invert</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">lower_p</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">upper_p</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">99.0</span><span class="p">,</span>
    <span class="n">lower_bound</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">upper_bound</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;normalize each channel of the image so that so that 0.0=lower percentile</span>
<span class="sd">    or lower bound and 1.0=upper percentile or upper bound of image intensities.</span>

<span class="sd">    The normalization can result in values &lt; 0 or &gt; 1 (no clipping).</span>

<span class="sd">    Based on https://github.com/MouseLand/cellpose/blob/4f5661983c3787efa443bbbd3f60256f4fd8bf53/cellpose/transforms.py#L375 # noqa E501</span>

<span class="sd">    optional inversion</span>

<span class="sd">    Parameters</span>
<span class="sd">    ------------</span>

<span class="sd">    img: ND-array (at least 3 dimensions)</span>

<span class="sd">    axis: channel axis to loop over for normalization</span>

<span class="sd">    invert: invert image (useful if cells are dark instead of bright)</span>

<span class="sd">    lower_p: Lower percentile for rescaling</span>

<span class="sd">    upper_p: Upper percentile for rescaling</span>

<span class="sd">    lower_bound: Lower fixed-value used for rescaling</span>

<span class="sd">    upper_bound: Upper fixed-value used for rescaling</span>

<span class="sd">    Returns</span>
<span class="sd">    ---------------</span>

<span class="sd">    img: ND-array, float32</span>
<span class="sd">        normalized image of same size</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;Image needs to have at least 3 dimensions&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">lower_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># ptp can still give nan&#39;s with weird images</span>
            <span class="n">i99</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">upper_p</span><span class="p">)</span>
            <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">lower_p</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i99</span> <span class="o">-</span> <span class="n">i1</span> <span class="o">&gt;</span> <span class="o">+</span><span class="mf">1e-3</span><span class="p">:</span>  <span class="c1"># np.ptp(img[k]) &gt; 1e-3:</span>
                <span class="n">img</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">normalize_percentile</span><span class="p">(</span>
                    <span class="n">img</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">lower</span><span class="o">=</span><span class="n">lower_p</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">upper_p</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">invert</span><span class="p">:</span>
                    <span class="n">img</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">img</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">img</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">lower_bound</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">upper_bound</span> <span class="o">-</span> <span class="n">lower_bound</span> <span class="o">&gt;</span> <span class="o">+</span><span class="mf">1e-3</span><span class="p">:</span>
                <span class="n">img</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">normalize_bounds</span><span class="p">(</span>
                    <span class="n">img</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">lower</span><span class="o">=</span><span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">upper_bound</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">invert</span><span class="p">:</span>
                    <span class="n">img</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">img</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">img</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No normalization method specified&quot;</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">img</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
       Copyright 2024
University of Zurich
(see <u><a href="https://github.com/fractal-analytics-platform/fractal-tasks-core/blob/main/LICENSE">
LICENSE
</a></u>).

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["content.code.annotate", "content.code.copy"], "search": "../../../../assets/javascripts/workers/search.74e28a9f.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.220ee61c.min.js"></script>
      
        
          <script src="../../../../javascripts/mathjax.js"></script>
        
      
        
          <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
        
      
        
          <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        
      
    
  </body>
</html>